{% extends 'base.html' %}

{% block title %}Listado de Sedes y Comedores{% endblock %}

{% block content %}
    <h1>Listado de Sedes y Comedores</h1>
    <p>A continuación se muestran todas las instituciones y comedores registrados en el sistema.</p>

    <div class="actions-bar">
        <!-- ========================================================== -->
        <!-- 1. NUEVO: FORMULARIO DE BÚSQUEDA                         -->
        <!-- ========================================================== -->
        <form method="GET" action="{% url 'planeacion:lista_comedores' %}" class="search-form">
            <input type="text" name="q" placeholder="Buscar por institución, sede, municipio..." value="{{ search_query }}">
            <button type="submit" class="btn btn-primary">Buscar</button>
        </form>

        <!-- BOTÓN MODIFICADO para abrir el modal de añadir -->
        <button id="add-comedor-btn" class="btn btn-success" data-create-url="{% url 'planeacion:lista_comedores' %}">
            <i class="fas fa-plus"></i> Añadir Sede
        </button>
    </div>

    <div class="table-container">
        <table class="alimentos-table">
            <thead>
                <tr>
                    <th>Institución / Sede</th>
                    <th>Municipio</th>
                    <th>Contacto</th>
                    <th>Teléfono</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for comedor in comedores_page %}
                <tr>
                    <td>
                        <strong>{{ comedor.institucion }}</strong><br>
                        <small>{{ comedor.sede }}</small>
                    </td>
                    <td>{{ comedor.municipio }}</td>
                    <td>{{ comedor.contacto|default:"--" }}</td>
                    <td>{{ comedor.telefono|default:"--" }}</td>
                    <td>
                        <!-- BOTÓN DE EDITAR con todos los data-* necesarios -->
                        <button class="btn-edit edit-comedor-btn"
                                data-id_codindem="{{ comedor.id_codindem }}"
                                data-id_departamento="{{ comedor.id_departamento }}"
                                data-departamento="{{ comedor.departamento }}"
                                data-id_municipio="{{ comedor.id_municipio }}"
                                data-municipio="{{ comedor.municipio }}"
                                data-id_tipo="{{ comedor.id_tipo }}"
                                data-tipo_comedor="{{ comedor.tipo_comedor }}"
                                data-dane="{{ comedor.dane }}"
                                data-cod_interface="{{ comedor.cod_interface }}"
                                data-institucion="{{ comedor.institucion }}"
                                data-sede="{{ comedor.sede }}"
                                data-direccion="{{ comedor.direccion|default:'' }}"
                                data-telefono="{{ comedor.telefono|default:'' }}"
                                data-contacto="{{ comedor.contacto|default:'' }}"
                                data-estado="{{ comedor.estado|default:'' }}">
                            Editar
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">
                        {% if search_query %}
                            No se encontraron sedes que coincidan con "<strong>{{ search_query }}</strong>".
                        {% else %}
                            No hay registros para mostrar.
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ========================================================== -->
    <!-- 2. CAMBIO: CONTROLES DE PAGINACIÓN ACTUALIZADOS            -->
    <!-- ========================================================== -->
    <div class="pagination-controls">
        {% if comedores_page.has_previous %}
            <a href="?q={{ search_query }}&page={{ comedores_page.previous_page_number }}" class="btn btn-secondary">&laquo; Anterior</a>
        {% endif %}

        <span class="current-page-info">
            Página {{ comedores_page.number }} de {{ comedores_page.paginator.num_pages }}
        </span>

        {% if comedores_page.has_next %}
            <a href="?q={{ search_query }}&page={{ comedores_page.next_page_number }}" class="btn btn-secondary">Siguiente &raquo;</a>
        {% endif %}
    </div>

    <!-- ========================================================== -->
    <!-- NUEVO: RESUMEN ANIDADO POR DEPARTAMENTO Y MUNICIPIO        -->
    <!-- ========================================================== -->
    <div class="summary-container">
        <h3>Resumen por Departamento y Municipio</h3>
        
        {% if nested_summary %}
            <div class="summary-columns">
                {% for departamento, municipios in nested_summary.items %}
                    <div class="summary-department">
                        <h4>{{ departamento }}</h4>
                        <ul>
                            {% for item in municipios %}
                                <li>{{ item.municipio }}: <span>{{ item.total }} sede(s)</span></li>
                            {% empty %}
                                <li>Sin municipios registrados</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% empty %}
                    <p>El diccionario nested_summary existe pero está vacío.</p>
                {% endfor %}
            </div>
        {% else %}
            <p>No hay datos para mostrar el resumen.</p>
        {% endif %}
    </div>

    <!-- MODAL (El mismo para Añadir y Editar) -->
    <div id="comedor-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Añadir Sede / Comedor</h2>
                <span class="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <form id="comedor-form" method="POST" action="">
                    {% csrf_token %}
                    <div class="form-scroll-container" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- ID CODINDEM - No editable en modo edición -->
                            <div class="form-group">
                                <label for="id_id_codindem">ID Único (PK) *</label>
                                <input type="text" name="id_codindem" id="id_id_codindem" class="form-control" required>
                            </div>
                            
                            <!-- ID Departamento -->
                            <div class="form-group">
                                <label for="id_id_departamento">ID Departamento</label>
                                <input type="number" name="id_departamento" id="id_id_departamento" class="form-control">
                            </div>
                            
                            <!-- Departamento -->
                            <div class="form-group">
                                <label for="id_departamento">Departamento *</label>
                                <input type="text" name="departamento" id="id_departamento" class="form-control" required>
                            </div>
                            
                            <!-- ID Municipio -->
                            <div class="form-group">
                                <label for="id_id_municipio">ID Municipio</label>
                                <input type="number" name="id_municipio" id="id_id_municipio" class="form-control">
                            </div>
                            
                            <!-- Municipio -->
                            <div class="form-group">
                                <label for="id_municipio">Municipio *</label>
                                <input type="text" name="municipio" id="id_municipio" class="form-control" required>
                            </div>
                            
                            <!-- ID Tipo -->
                            <div class="form-group">
                                <label for="id_id_tipo">ID Tipo</label>
                                <input type="number" name="id_tipo" id="id_id_tipo" class="form-control">
                            </div>
                            
                            <!-- Tipo de Comedor -->
                            <div class="form-group">
                                <label for="id_tipo_comedor">Tipo de Comedor</label>
                                <input type="text" name="tipo_comedor" id="id_tipo_comedor" class="form-control">
                            </div>
                            
                            <!-- DANE - No editable en modo edición -->
                            <div class="form-group">
                                <label for="id_dane">Código DANE *</label>
                                <input type="text" name="dane" id="id_dane" class="form-control" required>
                            </div>
                            
                            <!-- Código de Interfaz - No editable en modo edición -->
                            <div class="form-group">
                                <label for="id_cod_interface">Código de Interfaz *</label>
                                <input type="text" name="cod_interface" id="id_cod_interface" class="form-control" required>
                            </div>
                            
                            <!-- Institución -->
                            <div class="form-group">
                                <label for="id_institucion">Institución *</label>
                                <input type="text" name="institucion" id="id_institucion" class="form-control" required>
                            </div>
                            
                            <!-- Sede -->
                            <div class="form-group">
                                <label for="id_sede">Sede *</label>
                                <input type="text" name="sede" id="id_sede" class="form-control" required>
                            </div>
                            
                            <!-- Dirección -->
                            <div class="form-group">
                                <label for="id_direccion">Dirección</label>
                                <textarea name="direccion" id="id_direccion" rows="3" class="form-control"></textarea>
                            </div>
                            
                            <!-- Teléfono -->
                            <div class="form-group">
                                <label for="id_telefono">Teléfono</label>
                                <input type="text" name="telefono" id="id_telefono" class="form-control">
                            </div>
                            
                            <!-- Contacto -->
                            <div class="form-group">
                                <label for="id_contacto">Contacto</label>
                                <input type="text" name="contacto" id="id_contacto" class="form-control">
                            </div>
                            
                            <!-- Estado -->
                            <div class="form-group">
                                <label for="id_estado">Estado</label>
                                <input type="text" name="estado" id="id_estado" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary modal-cancel-btn">Cancelar</button>
                        <button type="submit" id="modal-submit-btn" class="btn btn-success">Guardar Sede</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


{% load static %}
<script src="{% static 'js/planeacion/comedores.js' %}"></script>

{% endblock %}
