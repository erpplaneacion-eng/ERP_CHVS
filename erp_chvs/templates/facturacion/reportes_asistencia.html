{% extends 'base.html' %}
{% load static %}

{% block title %}Reportes de Asistencia{% endblock %}

{% block content %}
<div class="sedes-container">
    <div class="page-header">
        <div class="header-left">
            <h2><i class="fas fa-file-pdf"></i> Generación de Reportes de Asistencia</h2>
            <p>Generar reportes PDF de asistencia por sede educativa</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'facturacion:facturacion_index' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
    </div>

    <!-- Sistema de Pestañas -->
    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-button active" data-tab="tab-normal">
                <i class="fas fa-file-alt"></i> Generación Normal
            </button>
            <button class="tab-button" data-tab="tab-prediligenciada">
                <i class="fas fa-magic"></i> Generación Prediligenciada
            </button>
        </div>
    </div>

    <!-- TAB 1: Generación Normal -->
    <div id="tab-normal" class="tab-content active">

        <!-- Filtros -->
        <div class="filters-container">
            <form method="get" class="filters-form">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="programa"><strong>Filtrar por Programa:</strong></label>
                        <select name="programa" id="programa" class="form-select">
                            <option value="">-- Seleccione un programa --</option>
                            {% for prog in programas %}
                            <option value="{{ prog.id }}"
                                {% if filtros_aplicados.programa.id == prog.id %}selected{% endif %}>
                                {{ prog.programa }} ({{ prog.municipio.nombre_municipio }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                    </div>
                </div>
                <div class="filter-info">
                    <p>Selecciona un programa para ver la lista de sedes educativas y poder generar los reportes.</p>
                </div>
            </form>
        </div>

        {% if filtros_aplicados.programa %}

        <!-- Generación masiva -->
        <div class="bulk-generation-container">
            <div class="bulk-header">
                <h3><i class="fas fa-download"></i> Generación Masiva por Programa</h3>
                <p>Generar reportes para todas las sedes de <strong>{{ filtros_aplicados.programa.programa }}</strong> con los mismos parámetros</p>
            </div>
            <div class="bulk-controls">
                <div class="bulk-form">
                    <div class="bulk-field">
                        <label for="bulk-mes">Mes para todas las sedes:</label>
                        <select id="bulk-mes" class="form-select">
                            {% for mes in meses_atencion %}
                                <option value="{{ mes }}">{{ mes|title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="bulk-field">
                        <label for="bulk-focalizacion">Focalización para todas las sedes:</label>
                        <select id="bulk-focalizacion" class="form-select">
                            {% for focalizacion in focalizaciones_disponibles %}
                                <option value="{{ focalizacion }}">{{ focalizacion }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="bulk-field bulk-dias-field">
                        <label>Días de Atención (Opcional):</label>
                        <input type="hidden" id="bulk-dias" value="">
                        <button type="button" class="btn btn-dias-picker w-100"
                                data-target="bulk-dias"
                                data-mes-target="bulk-mes">
                            <i class="fas fa-calendar-alt me-1"></i>
                            <span class="dias-label">Sin días (usa hábiles del mes)</span>
                        </button>
                        <small class="form-text text-muted">Si no seleccionas días, se usan los días hábiles del mes.</small>
                    </div>
                    <div class="bulk-field bulk-actions">
                        <button type="button" class="btn btn-success btn-lg" id="btn-generar-masivo"
                                data-programa-id="{{ filtros_aplicados.programa.id }}"
                                data-programa-nombre="{{ filtros_aplicados.programa.programa|escapejs }}">
                            <i class="fas fa-archive"></i> Generar ZIP Masivo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de sedes -->
        <div class="table-container">
            <div class="section-header">
                <h3>Sedes Educativas en: <strong>{{ filtros_aplicados.programa.programa }}</strong></h3>
                <p><small>O generar reportes individualmente por sede:</small></p>
            </div>
            <table class="data-table" id="sedesTable">
                <thead>
                    <tr>
                        <th>Sede Educativa</th>
                        <th>Mes de Atención</th>
                        <th>Focalización</th>
                        <th>Días de Atención (Opcional)</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sede in sedes %}
                    <tr id="sede-row-{{ sede.cod_interprise }}">
                        <td>
                            <strong>{{ sede.nombre_sede_educativa }}</strong><br>
                            <small class="text-muted">IE: {{ sede.codigo_ie.nombre_institucion }}</small>
                        </td>
                        <td>
                            <select class="form-select form-select-sm" id="mes-{{ sede.cod_interprise }}">
                                {% for mes in meses_atencion %}
                                    <option value="{{ mes }}">{{ mes|title }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm" id="focalizacion-{{ sede.cod_interprise }}">
                                {% for focalizacion in focalizaciones_disponibles %}
                                    <option value="{{ focalizacion }}">{{ focalizacion }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="hidden" id="dias-{{ sede.cod_interprise }}" value="">
                            <button type="button" class="btn btn-dias-picker btn-sm w-100"
                                    data-target="dias-{{ sede.cod_interprise }}"
                                    data-mes-target="mes-{{ sede.cod_interprise }}">
                                <i class="fas fa-calendar-alt me-1"></i>
                                <span class="dias-label">Sin días</span>
                            </button>
                        </td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-success btn-generar-asistencia"
                                    data-sede-cod="{{ sede.cod_interprise }}"
                                    data-programa-id="{{ filtros_aplicados.programa.id }}"
                                    title="Generar formato de asistencia para esta sede">
                                <i class="fas fa-download me-1"></i> Generar Reporte
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No se encontraron sedes para este programa.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% endif %}
    </div>
    <!-- FIN TAB 1 -->

    <!-- TAB 2: Generación Prediligenciada -->
    <div id="tab-prediligenciada" class="tab-content">
        <div class="config-prediligenciada-container">
            <h3><i class="fas fa-magic"></i> Configuración de PDF Prediligenciado</h3>
            <p>Configure las asistencias que desea marcar automáticamente en el PDF</p>

            <!-- Filtros básicos -->
            <div class="filter-row" style="display:flex;gap:15px;margin-bottom:20px;">
                <div class="filter-group" style="flex:1;">
                    <label for="pred-programa"><strong>Programa:</strong></label>
                    <select id="pred-programa" class="form-select">
                        <option value="">-- Seleccione --</option>
                        {% for prog in programas %}
                        <option value="{{ prog.id }}" data-municipio="{{ prog.municipio.nombre_municipio }}">
                            {{ prog.programa }} ({{ prog.municipio.nombre_municipio }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group" style="flex:1;">
                    <label for="pred-sede"><strong>Sede:</strong></label>
                    <select id="pred-sede" class="form-select" disabled>
                        <option value="">-- Seleccione programa primero --</option>
                    </select>
                </div>
                <div class="filter-group" style="flex:1;">
                    <label for="pred-focalizacion"><strong>Focalización:</strong></label>
                    <select id="pred-focalizacion" class="form-select" disabled>
                        <option value="">-- Seleccione sede primero --</option>
                    </select>
                </div>
            </div>

            <div class="filter-row" style="display:flex;gap:15px;margin-bottom:20px;">
                <div class="filter-group" style="flex:1;">
                    <label for="pred-mes"><strong>Mes:</strong></label>
                    <select id="pred-mes" class="form-select">
                        {% for mes in meses_atencion %}
                        <option value="{{ mes }}">{{ mes|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group" style="flex:1;">
                    <label for="pred-complemento"><strong>Complemento:</strong></label>
                    <select id="pred-complemento" class="form-select" disabled>
                        <option value="">-- Seleccione focalización primero --</option>
                        <option value="CAP AM">CAP AM</option>
                        <option value="CAP PM">CAP PM</option>
                        <option value="Almuerzo JU">Almuerzo JU</option>
                        <option value="Refuerzo">Refuerzo</option>
                    </select>
                </div>
                <div class="filter-group" style="flex:1;display:flex;align-items:flex-end;">
                    <button type="button" id="btn-cargar-estudiantes" class="btn btn-primary" style="width:100%;" disabled>
                        <i class="fas fa-sync"></i> Cargar Estudiantes
                    </button>
                </div>
            </div>

            <!-- Información de estudiantes -->
            <div id="info-estudiantes-container" style="display:none;">
                <div class="info-estudiantes">
                    <h4><i class="fas fa-users"></i> Estudiantes Disponibles</h4>
                    <div class="info-niveles">
                        <div class="nivel-badge"><div>Preescolar</div><strong id="count-preescolar">0</strong></div>
                        <div class="nivel-badge"><div>Primaria 1-3</div><strong id="count-primaria-1-3">0</strong></div>
                        <div class="nivel-badge"><div>Primaria 4-5</div><strong id="count-primaria-4-5">0</strong></div>
                        <div class="nivel-badge"><div>Secundaria</div><strong id="count-secundaria">0</strong></div>
                        <div class="nivel-badge"><div>Media</div><strong id="count-media">0</strong></div>
                        <div class="nivel-badge" style="background:#c8e6c9;"><div>TOTAL</div><strong id="count-total">0</strong></div>
                    </div>
                </div>

                <!-- Configuración de días (Tab 2) -->
                <div style="margin-top:20px;">
                    <h4><i class="fas fa-calendar-alt"></i> Configuración de Días</h4>
                    <div style="margin-bottom:15px;">
                        <button type="button" id="btn-agregar-dia" class="btn-agregar-dia">
                            <i class="fas fa-plus"></i> Agregar Día
                        </button>
                        <small style="color:#666;margin-left:10px;">
                            <i class="fas fa-info-circle"></i> Configure cuántos estudiantes deben marcar asistencia por día y nivel
                        </small>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="tabla-dias-config">
                            <thead>
                                <tr>
                                    <th style="width:70px;">Día</th>
                                    <th style="width:90px;">Total</th>
                                    <th>Preescolar</th>
                                    <th>Prim 1-3</th>
                                    <th>Prim 4-5</th>
                                    <th>Secundaria</th>
                                    <th>Media</th>
                                    <th style="width:90px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-dias-body">
                                <tr>
                                    <td colspan="8" style="text-align:center;color:#999;padding:30px;">
                                        No hay días configurados. Haga clic en "Agregar Día" para empezar.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Totales -->
                <div class="total-section">
                    <h4><i class="fas fa-calculator"></i> Resumen Total del Mes</h4>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-top:10px;">
                        <div><strong>Preescolar:</strong> <span id="total-preescolar">0</span></div>
                        <div><strong>Prim 1-3:</strong> <span id="total-primaria-1-3">0</span></div>
                        <div><strong>Prim 4-5:</strong> <span id="total-primaria-4-5">0</span></div>
                        <div><strong>Secundaria:</strong> <span id="total-secundaria">0</span></div>
                        <div><strong>Media:</strong> <span id="total-media">0</span></div>
                        <div style="background:white;padding:10px;border-radius:5px;grid-column:span 2;">
                            <strong>TOTAL:</strong> <span id="total-general" style="font-size:20px;color:#4caf50;">0</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top:25px;text-align:center;">
                    <button type="button" id="btn-generar-prediligenciado" class="btn btn-success btn-lg" style="min-width:250px;" disabled>
                        <i class="fas fa-file-pdf"></i> Generar PDF Prediligenciado
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN TAB 2 -->

</div>

<!-- Popover de calendario compartido -->
<div id="dias-calendar-popover" style="display:none;" role="dialog" aria-label="Selector de días">
    <div class="cal-header">
        <span id="cal-month-label">MES AÑO</span>
    </div>
    <div class="cal-grid" id="cal-grid-body"></div>
    <div class="cal-footer">
        <button type="button" class="btn-cal-clear" id="cal-btn-clear">
            <i class="fas fa-trash-alt me-1"></i>Limpiar
        </button>
        <span class="cal-count" id="cal-count-label">0 días sel.</span>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/facturacion/reportes_asistencia.js' %}"></script>
{% endblock %}
