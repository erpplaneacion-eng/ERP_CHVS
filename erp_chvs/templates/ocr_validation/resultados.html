{% extends 'base.html' %}
{% load static %}

{% block title %}Resultados de Validación OCR - ERP CHVS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modules/ocr_validation.css' %}">
{% endblock %}

{% block content %}
<div class="ocr-container">
    <div class="page-header">
        <div class="header-left">
            <h2><i class="fas fa-file-pdf"></i> Resultados de Validación OCR</h2>
            <p>Validación: {{ validacion.archivo_nombre }} - {{ validacion.sede_educativa }}</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'ocr_validation:ocr_index' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Nueva Validación
            </a>
            <a href="{% url 'ocr_validation:listado' %}" class="btn btn-info">
                <i class="fas fa-list"></i> Ver Todas
            </a>
            <a href="{% url 'ocr_validation:descargar_reporte' validacion.id %}" class="btn btn-success">
                <i class="fas fa-download"></i> Descargar Reporte
            </a>
        </div>
    </div>

    <!-- Resumen Ejecutivo -->
    <div class="summary-section">
        <div class="summary-card">
            <div class="summary-header">
                <h3><i class="fas fa-chart-bar"></i> Resumen Ejecutivo</h3>
            </div>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-icon archivo">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="summary-content">
                        <h4>{{ validacion.archivo_nombre }}</h4>
                        <p>{{ validacion.sede_educativa }} - {{ validacion.mes_atencion }} {{ validacion.ano }}</p>
                        <small>Procesado: {{ validacion.fecha_procesamiento|date:"d/m/Y H:i" }}</small>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-icon {% if validacion.errores_criticos > 0 %}critico{% elif validacion.errores_advertencia > 0 %}advertencia{% else %}exito{% endif %}">
                        <i class="fas fa-{% if validacion.errores_criticos > 0 %}times-circle{% elif validacion.errores_advertencia > 0 %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
                    </div>
                    <div class="summary-content">
                        <h4>Estado de Validación</h4>
                        <p>
                            {% if validacion.errores_criticos > 0 %}
                                {{ validacion.errores_criticos }} errores críticos
                            {% elif validacion.errores_advertencia > 0 %}
                                {{ validacion.errores_advertencia }} advertencias
                            {% else %}
                                Sin errores detectados
                            {% endif %}
                        </p>
                        <small>Total errores: {{ validacion.total_errores }}</small>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-icon tiempo">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="summary-content">
                        <h4>Tiempo de Procesamiento</h4>
                        <p>{{ validacion.tiempo_procesamiento|floatformat:2 }} segundos</p>
                        <small>Estado: {{ validacion.get_estado_display }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Errores por Severidad -->
    {% if errores_criticos %}
    <div class="errors-section">
        <div class="errors-card criticos">
            <div class="errors-header">
                <h4><i class="fas fa-times-circle"></i> Errores Críticos ({{ errores_criticos|length }})</h4>
                <span class="badge badge-critico">{{ errores_criticos|length }} errores</span>
            </div>
            <div class="errors-content">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-danger">
                            <tr>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Página</th>
                                <th>Fila</th>
                                <th>Campo</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for error in errores_criticos %}
                            <tr>
                                <td>
                                    <span class="error-type">{{ error.tipo_error }}</span>
                                </td>
                                <td>{{ error.descripcion }}</td>
                                <td class="text-center">{{ error.pagina }}</td>
                                <td class="text-center">{{ error.fila_estudiante|default:"-" }}</td>
                                <td>{{ error.columna_campo|default:"-" }}</td>
                                <td>{{ error.fecha_creacion|date:"d/m/Y H:i" }}</td>
                                <td>
                                    {% if not error.resuelto %}
                                    <button class="btn btn-sm btn-success" onclick="marcarResuelto({{ error.id }})">
                                        <i class="fas fa-check"></i> Marcar Resuelto
                                    </button>
                                    {% else %}
                                    <span class="badge badge-success">Resuelto</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if errores_advertencia %}
    <div class="errors-section">
        <div class="errors-card advertencias">
            <div class="errors-header">
                <h4><i class="fas fa-exclamation-triangle"></i> Advertencias ({{ errores_advertencia|length }})</h4>
                <span class="badge badge-advertencia">{{ errores_advertencia|length }} advertencias</span>
            </div>
            <div class="errors-content">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-warning">
                            <tr>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Página</th>
                                <th>Fila</th>
                                <th>Campo</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for error in errores_advertencia %}
                            <tr>
                                <td>
                                    <span class="error-type">{{ error.tipo_error }}</span>
                                </td>
                                <td>{{ error.descripcion }}</td>
                                <td class="text-center">{{ error.pagina }}</td>
                                <td class="text-center">{{ error.fila_estudiante|default:"-" }}</td>
                                <td>{{ error.columna_campo|default:"-" }}</td>
                                <td>{{ error.fecha_creacion|date:"d/m/Y H:i" }}</td>
                                <td>
                                    {% if not error.resuelto %}
                                    <button class="btn btn-sm btn-success" onclick="marcarResuelto({{ error.id }})">
                                        <i class="fas fa-check"></i> Marcar Resuelto
                                    </button>
                                    {% else %}
                                    <span class="badge badge-success">Resuelto</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if errores_info %}
    <div class="errors-section">
        <div class="errors-card info">
            <div class="errors-header">
                <h4><i class="fas fa-info-circle"></i> Información ({{ errores_info|length }})</h4>
                <span class="badge badge-info">{{ errores_info|length }} elementos</span>
            </div>
            <div class="errors-content">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-info">
                            <tr>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Página</th>
                                <th>Fila</th>
                                <th>Campo</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for error in errores_info %}
                            <tr>
                                <td>{{ error.tipo_error }}</td>
                                <td>{{ error.descripcion }}</td>
                                <td class="text-center">{{ error.pagina }}</td>
                                <td class="text-center">{{ error.fila_estudiante|default:"-" }}</td>
                                <td>{{ error.columna_campo|default:"-" }}</td>
                                <td>{{ error.fecha_creacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sin Errores -->
    {% if not errores_criticos and not errores_advertencia and not errores_info %}
    <div class="no-errors-section">
        <div class="no-errors-card">
            <div class="no-errors-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3>¡Validación Perfecta!</h3>
            <p>No se encontraron errores en el documento procesado.</p>
            <div class="no-errors-details">
                <p><strong>Archivo:</strong> {{ validacion.archivo_nombre }}</p>
                <p><strong>Sede:</strong> {{ validacion.sede_educativa }}</p>
                <p><strong>Período:</strong> {{ validacion.mes_atencion }} {{ validacion.ano }}</p>
                <p><strong>Complemento:</strong> {{ validacion.tipo_complemento }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Errores por Página -->
    {% if errores_por_pagina %}
    <div class="pages-section">
        <div class="pages-card">
            <div class="pages-header">
                <h4><i class="fas fa-file-alt"></i> Errores por Página</h4>
            </div>
            <div class="pages-content">
                {% for pagina, errores_pagina in errores_por_pagina.items %}
                <div class="page-errors">
                    <div class="page-header">
                        <h5>Página {{ pagina }}</h5>
                        <span class="badge badge-primary">{{ errores_pagina|length }} errores</span>
                    </div>
                    <div class="page-errors-list">
                        {% for error in errores_pagina %}
                        <div class="error-item {% if error.severidad == 'critico' %}critico{% elif error.severidad == 'advertencia' %}advertencia{% else %}info{% endif %}">
                            <div class="error-info">
                                <strong>{{ error.tipo_error }}:</strong> {{ error.descripcion }}
                                {% if error.fila_estudiante %}
                                <br><small>Fila: {{ error.fila_estudiante }}</small>
                                {% endif %}
                            </div>
                            <div class="error-actions">
                                {% if not error.resuelto %}
                                <button class="btn btn-sm btn-success" onclick="marcarResuelto({{ error.id }})">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% else %}
                                <span class="badge badge-success">Resuelto</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Información Adicional -->
    <div class="info-section">
        <div class="info-card">
            <div class="info-header">
                <h4><i class="fas fa-info-circle"></i> Información del Procesamiento</h4>
            </div>
            <div class="info-content">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Detalles del Archivo</h6>
                        <ul class="list-unstyled">
                            <li><strong>Archivo:</strong> {{ validacion.archivo_nombre }}</li>
                            <li><strong>Fecha de procesamiento:</strong> {{ validacion.fecha_procesamiento|date:"d/m/Y H:i:s" }}</li>
                            <li><strong>Tiempo de procesamiento:</strong> {{ validacion.tiempo_procesamiento|floatformat:2 }} segundos</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Estadísticas de Validación</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total de errores:</strong> {{ validacion.total_errores }}</li>
                            <li><strong>Errores críticos:</strong> {{ validacion.errores_criticos }}</li>
                            <li><strong>Advertencias:</strong> {{ validacion.errores_advertencia }}</li>
                        </ul>
                    </div>
                </div>

                {% if validacion.observaciones %}
                <div class="mt-3">
                    <h6>Observaciones</h6>
                    <p class="alert alert-info">{{ validacion.observaciones }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function marcarResuelto(errorId) {
    fetch(`/ocr_validation/error/${errorId}/resolver/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error interno del servidor');
    });
}
</script>
{% endblock %}