{% extends 'base.html' %}
{% load static %}

{% block title %}Validaci√≥n OCR de PDFs - ERP CHVS{% endblock %}

{% block content %}
<div class="ocr-container">
    <div class="page-header">
        <div class="header-left">
            <h2><i class="fas fa-file-pdf"></i> Validaci√≥n OCR de PDFs</h2>
            <p>Sistema de validaci√≥n con Inteligencia Artificial de √∫ltima generaci√≥n</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'facturacion:facturacion_index' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Facturaci√≥n
            </a>
            <a href="{% url 'ocr_validation:dashboard_dataframes' %}" class="btn btn-success">
                <i class="fas fa-chart-line"></i> üìä Dashboard DataFrames
            </a>
            <a href="{% url 'ocr_validation:listado' %}" class="btn btn-info">
                <i class="fas fa-list"></i> Ver Historial
            </a>
        </div>
    </div>

    <!-- Informaci√≥n del Sistema -->
    <div class="system-info-card">
        <div class="info-header">
            <h3><i class="fas fa-info-circle"></i> Informaci√≥n del Sistema</h3>
        </div>
        <div class="info-content">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="info-text">
                        <h4>LandingAI ADE</h4>
                        <p>Procesamiento con IA avanzada</p>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="info-text">
                        <h4>Validaci√≥n Inteligente</h4>
                        <p>Detecci√≥n autom√°tica de errores en campos manuales</p>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="info-text">
                        <h4>Reportes Detallados</h4>
                        <p>Tabla completa de errores por sede educativa</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Opciones de Procesamiento -->
    <div class="processing-options">
        <div class="options-header">
            <h3><i class="fas fa-route"></i> Opciones de Procesamiento</h3>
            <p>Elige el tipo de an√°lisis que necesitas para tu PDF</p>
        </div>
        <div class="options-grid">
            <div class="option-card">
                <div class="option-header">
                    <i class="fas fa-search-plus"></i>
                    <h4>Validaci√≥n Tradicional</h4>
                </div>
                <div class="option-content">
                    <p>An√°lisis de errores y validaci√≥n de campos diligenciados manualmente.</p>
                    <ul>
                        <li>‚úÖ Detecci√≥n de campos vac√≠os</li>
                        <li>‚úÖ Validaci√≥n de firmas</li>
                        <li>‚úÖ Control de raciones</li>
                        <li>‚úÖ Reportes de errores</li>
                    </ul>
                    <div class="option-action">
                        <p><strong>üëá Usa el formulario de abajo</strong></p>
                    </div>
                </div>
            </div>
            <div class="option-card featured">
                <div class="option-header">
                    <i class="fas fa-chart-line"></i>
                    <h4>Extracci√≥n a DataFrames</h4>
                    <span class="badge-new">üÜï NUEVO</span>
                </div>
                <div class="option-content">
                    <p>Extrae datos estructurados y convierte a tablas interactivas.</p>
                    <ul>
                        <li>ü§ñ IA Avanzada (LandingAI)</li>
                        <li>üìä Tablas interactivas</li>
                        <li>üìÅ Exportaci√≥n CSV/Excel</li>
                        <li>üìà Dashboard con estad√≠sticas</li>
                    </ul>
                    <div class="option-action">
                        <a href="{% url 'ocr_validation:dashboard_dataframes' %}" class="btn btn-success btn-lg">
                            <i class="fas fa-rocket"></i> Ir a Dashboard DataFrames
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- √Årea de Carga de PDF -->
    <div class="upload-section">
        <div class="upload-card">
            <div class="upload-header">
                <h3><i class="fas fa-upload"></i> Cargar PDF para Validaci√≥n</h3>
                <p>Sube un PDF diligenciado manualmente para an√°lisis autom√°tico</p>
            </div>

            <form id="pdfUploadForm" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="form-group">
                    <label for="archivo_pdf" class="form-label">
                        <i class="fas fa-file-pdf"></i> Seleccionar Archivo PDF:
                    </label>
                    <div class="file-input-wrapper">
                        <input type="file" class="form-control" name="archivo_pdf" id="archivo_pdf"
                               accept=".pdf" required>
                        <div class="file-input-feedback"></div>
                    </div>
                    <small class="form-text text-muted">
                        Solo archivos PDF. Tama√±o m√°ximo: 10MB
                    </small>
                </div>

                <div class="upload-preview" id="uploadPreview" style="display: none;">
                    <h5><i class="fas fa-eye"></i> Informaci√≥n del Archivo</h5>
                    <div class="preview-content">
                        <div class="preview-item">
                            <strong>Nombre:</strong> <span id="preview-nombre"></span>
                        </div>
                        <div class="preview-item">
                            <strong>Tama√±o:</strong> <span id="preview-tamano"></span>
                        </div>
                        <div class="preview-item">
                            <strong>Sede Detectada:</strong> <span id="preview-sede"></span>
                        </div>
                        <div class="preview-item">
                            <strong>Mes:</strong> <span id="preview-mes"></span>
                        </div>
                    </div>
                </div>

                <div class="upload-actions">
                    <button type="submit" class="btn btn-primary btn-lg" id="procesarBtn">
                        <i class="fas fa-cogs"></i> Procesar con OCR
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                        <i class="fas fa-trash"></i> Limpiar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- √Årea de Procesamiento -->
    <div class="processing-section" id="processingSection" style="display: none;">
        <div class="processing-card">
            <div class="processing-header">
                <h4><i class="fas fa-spinner fa-spin"></i> Procesando PDF...</h4>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%" id="progressBar">
                        0%
                    </div>
                </div>
            </div>
            <div class="processing-status" id="processingStatus">
                <p>Iniciando procesamiento OCR...</p>
            </div>
        </div>
    </div>

    <!-- √Årea de Resultados -->
    <div class="results-section" id="resultsSection" style="display: none;">
        <div class="results-card">
            <div class="results-header">
                <h4><i class="fas fa-check-circle"></i> Procesamiento Completado</h4>
            </div>
            <div class="results-content">
                <div class="results-summary">
                    <div class="summary-item">
                        <div class="summary-icon success">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="summary-text">
                            <h5>Archivo Procesado</h5>
                            <p id="summary-archivo"></p>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon" id="summary-icon-errores">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="summary-text">
                            <h5>Errores Encontrados</h5>
                            <p id="summary-errores"></p>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="summary-text">
                            <h5>Tiempo de Procesamiento</h5>
                            <p id="summary-tiempo"></p>
                        </div>
                    </div>
                </div>

                <div class="results-actions">
                    <a href="#" class="btn btn-primary" id="verDetallesBtn">
                        <i class="fas fa-eye"></i> Ver Detalles Completos
                    </a>
                    <button class="btn btn-success" onclick="procesarOtroArchivo()">
                        <i class="fas fa-plus"></i> Procesar Otro Archivo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- √Årea de Errores -->
    <div class="errors-section" id="errorsSection" style="display: none;">
        <div class="errors-card">
            <div class="errors-header">
                <h4><i class="fas fa-exclamation-triangle"></i> Errores Detectados</h4>
            </div>
            <div class="errors-content">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-info-circle"></i> Campos que se Validan</h6>
                    <p>El sistema valida autom√°ticamente los siguientes campos que deben ser diligenciados manualmente:</p>
                    <ul>
                        <li><strong>Raciones Diarias/Mensuales Entregadas:</strong> Validaci√≥n num√©rica y l√≥gica</li>
                        <li><strong>Firmas:</strong> Detecci√≥n de presencia de firmas legibles</li>
                        <li><strong>Casillas de Asistencia:</strong> Detecci√≥n de posici√≥n correcta de "X"</li>
                        <li><strong>Totales:</strong> Verificaci√≥n de c√°lculos matem√°ticos</li>
                    </ul>
                </div>

                <div class="errors-preview" id="errorsPreview">
                    <!-- Se llena din√°micamente con errores encontrados -->
                </div>
            </div>
        </div>
    </div>

    <!-- Configuraci√≥n OCR -->
    {% if configuracion_ocr %}
    <div class="config-section">
        <div class="config-card">
            <div class="config-header">
                <h5><i class="fas fa-cog"></i> Configuraci√≥n OCR Actual</h5>
            </div>
            <div class="config-content">
                <div class="config-item">
                    <span class="config-label">Modelo LandingAI:</span>
                    <span class="config-value">dpt-2-latest</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Confianza M√≠nima:</span>
                    <span class="config-value">{{ configuracion_ocr.confianza_minima }}%</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Detectar Firmas:</span>
                    <span class="config-value">{% if configuracion_ocr.detectar_firmas %}S√≠{% else %}No{% endif %}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}