{% extends 'base.html' %}
{% load static %}

{% block title %}Error - ERP CHVS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modules/ocr_validation.css' %}">
{% endblock %}

{% block content %}
<div class="ocr-container">
    <div class="page-header">
        <div class="header-left">
            <h2><i class="fas fa-exclamation-triangle"></i> Error en el Sistema</h2>
            <p>Ha ocurrido un problema procesando su solicitud</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'ocr_validation:ocr_index' %}" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Volver al Inicio
            </a>
            <a href="{% url 'facturacion:facturacion_index' %}" class="btn btn-secondary">
                <i class="fas fa-home"></i> Ir a Facturaci√≥n
            </a>
        </div>
    </div>

    <!-- Error Principal -->
    <div class="error-section">
        <div class="error-card">
            <div class="error-header">
                <div class="error-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <h3>Error en el Procesamiento</h3>
            </div>
            <div class="error-content">
                <div class="alert alert-danger">
                    <h5><i class="fas fa-times-circle"></i> Error</h5>
                    {% if error %}
                    <p>{{ error }}</p>
                    {% else %}
                    <p>Ha ocurrido un error inesperado en el sistema. Por favor, int√©ntelo de nuevo.</p>
                    {% endif %}
                </div>

                <div class="error-actions">
                    <a href="{% url 'ocr_validation:ocr_index' %}" class="btn btn-primary">
                        <i class="fas fa-redo"></i> Intentar de Nuevo
                    </a>
                    <button class="btn btn-info" onclick="verDetallesError()">
                        <i class="fas fa-search"></i> Ver Detalles T√©cnicos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n de Ayuda -->
    <div class="help-section">
        <div class="help-card">
            <div class="help-header">
                <h4><i class="fas fa-question-circle"></i> ¬øNecesita Ayuda?</h4>
            </div>
            <div class="help-content">
                <div class="help-item">
                    <div class="help-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="help-text">
                        <h6>Problemas con Archivos PDF</h6>
                        <p>Aseg√∫rese de que el archivo PDF:</p>
                        <ul>
                            <li>Sea un PDF v√°lido (no imagen ni otro formato)</li>
                            <li>Tenga un tama√±o menor a 10MB</li>
                            <li>Contenga texto legible (no solo im√°genes)</li>
                            <li>Est√© diligenciado correctamente</li>
                        </ul>
                    </div>
                </div>

                <div class="help-item">
                    <div class="help-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="help-text">
                        <h6>Problemas de Configuraci√≥n</h6>
                        <p>Si el sistema no procesa archivos:</p>
                        <ul>
                            <li>Ejecute: <code>python verificar_sistema.py</code></li>
                            <li>Ejecute: <code>python buscar_landingai.py</code></li>
                            <li>Verifique que LandingAI est√© instalado</li>
                            <li>Verifique que Poppler est√© configurado</li>
                        </ul>
                    </div>
                </div>

                <div class="help-item">
                    <div class="help-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="help-text">
                        <h6>Problemas de Base de Datos</h6>
                        <p>Si hay errores de base de datos:</p>
                        <ul>
                            <li>Ejecute las migraciones: <code>python manage.py migrate</code></li>
                            <li>Verifique conexi√≥n a PostgreSQL</li>
                            <li>Verifique permisos de usuario</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n T√©cnica (Oculto por defecto) -->
    <div class="technical-info" id="technicalInfo" style="display: none;">
        <div class="tech-card">
            <div class="tech-header">
                <h4><i class="fas fa-code"></i> Informaci√≥n T√©cnica</h4>
                <button class="btn btn-sm btn-secondary" onclick="ocultarDetallesError()">
                    <i class="fas fa-times"></i> Ocultar
                </button>
            </div>
            <div class="tech-content">
                <div class="alert alert-info">
                    <h6>Detalles del Sistema:</h6>
                    <ul>
                        <li><strong>Aplicaci√≥n:</strong> OCR Validation v1.0</li>
                        <li><strong>LandingAI:</strong> Instalado y configurado</li>
                        <li><strong>Poppler:</strong> Funcionando correctamente</li>
                        <li><strong>Base de datos:</strong> PostgreSQL conectado</li>
                        <li><strong>Estado:</strong> Sistema operativo en funcionamiento</li>
                    </ul>
                </div>

                <div class="alert alert-warning">
                    <h6>Pasos para Solucionar Problemas:</h6>
                    <ol>
                        <li>Ejecute <code>python verificar_sistema.py</code> para diagn√≥stico</li>
                        <li>Ejecute <code>python buscar_landingai.py</code> para configurar OCR</li>
                        <li>Verifique que las migraciones est√©n aplicadas</li>
                        <li>Reinicie el servidor Django si es necesario</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones R√°pidas -->
    <div class="quick-actions">
        <div class="actions-card">
            <div class="actions-header">
                <h4><i class="fas fa-bolt"></i> Acciones R√°pidas</h4>
            </div>
            <div class="actions-content">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="verificarSistema()">
                        <i class="fas fa-search"></i> Verificar Sistema
                    </button>
                    <button class="btn btn-info" onclick="verDetallesError()">
                        <i class="fas fa-info-circle"></i> Ver Detalles T√©cnicos
                    </button>
                    <a href="{% url 'ocr_validation:estadisticas' %}" class="btn btn-success">
                        <i class="fas fa-chart-bar"></i> Ver Estad√≠sticas
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function verDetallesError() {
    const techInfo = document.getElementById('technicalInfo');
    if (techInfo) {
        techInfo.style.display = 'block';
    }
}

function ocultarDetallesError() {
    const techInfo = document.getElementById('technicalInfo');
    if (techInfo) {
        techInfo.style.display = 'none';
    }
}

function verificarSistema() {
    // Crear nueva ventana con verificaci√≥n del sistema
    const ventana = window.open('', '_blank', 'width=800,height=600');
    ventana.document.write(`
        <html>
        <head><title>Verificaci√≥n del Sistema OCR</title></head>
        <body style="font-family: Arial, sans-serif; padding: 20px;">
            <h2>üîç Verificaci√≥n del Sistema OCR</h2>
            <p>Ejecutando diagn√≥sticos...</p>
            <p>Consulte la consola del servidor para ver resultados detallados.</p>
        </body>
        </html>
    `);

    // Ejecutar verificaci√≥n en la ventana actual
    fetch('/ocr_validation/estadisticas/')
        .then(response => {
            if (response.ok) {
                ventana.location.href = '/ocr_validation/estadisticas/';
            } else {
                ventana.document.write(`
                    <p>‚ùå Error accediendo al sistema de estad√≠sticas.</p>
                    <p>Ejecute manualmente: python verificar_sistema.py</p>
                `);
            }
        })
        .catch(error => {
            ventana.document.write(`
                <p>‚ùå Error de conexi√≥n.</p>
                <p>Verifique que el servidor Django est√© ejecut√°ndose.</p>
            `);
        });
}
</script>
{% endblock %}