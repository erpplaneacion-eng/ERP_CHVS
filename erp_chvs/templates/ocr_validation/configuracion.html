{% extends 'base.html' %}
{% load static %}

{% block title %}Configuración OCR - ERP CHVS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modules/ocr_validation.css' %}">
{% endblock %}

{% block content %}
<div class="ocr-container">
    <div class="page-header">
        <div class="header-left">
            <h2><i class="fas fa-cog"></i> Configuración del Sistema OCR</h2>
            <p>Configura parámetros avanzados del sistema de validación OCR</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'ocr_validation:ocr_index' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver a OCR
            </a>
            <a href="{% url 'ocr_validation:estadisticas' %}" class="btn btn-info">
                <i class="fas fa-chart-bar"></i> Ver Estadísticas
            </a>
        </div>
    </div>

    <!-- Configuración Actual -->
    <div class="config-section">
        <div class="config-card">
            <div class="config-header">
                <h3><i class="fas fa-cogs"></i> Configuración Actual del Sistema</h3>
            </div>
            <div class="config-content">
                {% if configuracion %}
                <div class="current-config">
                    <div class="config-item">
                        <span class="config-label">Confianza Mínima OCR:</span>
                        <span class="config-value">{{ configuracion.confianza_minima }}%</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Configuración Tesseract:</span>
                        <span class="config-value">{{ configuracion.tesseract_config }}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Detección de Firmas:</span>
                        <span class="config-value">{% if configuracion.detectar_firmas %}Activada{% else %}Desactivada{% endif %}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Procesamiento de Imágenes:</span>
                        <span class="config-value">{% if configuracion.procesar_imagenes %}Activado{% else %}Desactivado{% endif %}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Última Actualización:</span>
                        <span class="config-value">{{ configuracion.fecha_actualizacion|date:"d/m/Y H:i" }}</span>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> Configuración no Inicializada</h6>
                    <p>No se ha creado una configuración OCR aún. Se usarán valores por defecto.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Formulario de Configuración -->
    <div class="config-form-section">
        <div class="form-card">
            <div class="form-header">
                <h4><i class="fas fa-edit"></i> Modificar Configuración</h4>
                <p>Ajusta los parámetros del sistema OCR según tus necesidades</p>
            </div>

            <form method="post" class="config-form">
                {% csrf_token %}

                <div class="form-section">
                    <h5><i class="fas fa-robot"></i> Configuración OCR</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tesseract_config">Configuración Tesseract:</label>
                            <input type="text" class="form-control" name="tesseract_config" id="tesseract_config"
                                   value="{% if configuracion %}{{ configuracion.tesseract_config }}{% else %}--oem 3 --psm 6{% endif %}"
                                   placeholder="--oem 3 --psm 6">
                            <small class="form-text text-muted">
                                Parámetros avanzados para Tesseract OCR. Usa valores estándar si no estás seguro.
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="confianza_minima">Confianza Mínima (%):</label>
                            <input type="number" class="form-control" name="confianza_minima" id="confianza_minima"
                                   min="0" max="100" step="0.1"
                                   value="{% if configuracion %}{{ configuracion.confianza_minima }}{% else %}60.0{% endif %}">
                            <small class="form-text text-muted">
                                Confianza mínima requerida para considerar texto válido (0-100%).
                            </small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h5><i class="fas fa-search"></i> Configuración de Detección</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tolerancia_posicion_x">Tolerancia Posición X (puntos):</label>
                            <input type="number" class="form-control" name="tolerancia_posicion_x" id="tolerancia_posicion_x"
                                   min="0" max="50" step="0.1"
                                   value="{% if configuracion %}{{ configuracion.tolerancia_posicion_x }}{% else %}5.0{% endif %}">
                            <small class="form-text text-muted">
                                Tolerancia para detectar posición de marcas "X" en celdas.
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="tolerancia_posicion_y">Tolerancia Posición Y (puntos):</label>
                            <input type="number" class="form-control" name="tolerancia_posicion_y" id="tolerancia_posicion_y"
                                   min="0" max="50" step="0.1"
                                   value="{% if configuracion %}{{ configuracion.tolerancia_posicion_y }}{% else %}5.0{% endif %}">
                            <small class="form-text text-muted">
                                Tolerancia vertical para detección de posición.
                            </small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h5><i class="fas fa-toggle-on"></i> Características de Procesamiento</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="permitir_texto_parcial" id="permitir_texto_parcial"
                                       {% if configuracion.permitir_texto_parcial %}checked{% endif %}>
                                <label class="form-check-label" for="permitir_texto_parcial">
                                    Permitir Texto Parcial
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Permite texto parcialmente reconocido como válido.
                            </small>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="detectar_firmas" id="detectar_firmas"
                                       {% if configuracion.detectar_firmas %}checked{% endif %}>
                                <label class="form-check-label" for="detectar_firmas">
                                    Detectar Presencia de Firmas
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Analiza automáticamente la presencia y legibilidad de firmas.
                            </small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="procesar_imagenes" id="procesar_imagenes"
                                       {% if configuracion.procesar_imagenes %}checked{% endif %}>
                                <label class="form-check-label" for="procesar_imagenes">
                                    Procesar Imágenes Adjuntas
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Procesa imágenes adicionales encontradas en el PDF.
                            </small>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="guardar_imagenes_temporales" id="guardar_imagenes_temporales"
                                       {% if configuracion.guardar_imagenes_temporales %}checked{% endif %}>
                                <label class="form-check-label" for="guardar_imagenes_temporales">
                                    Guardar Imágenes Temporales
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Mantiene imágenes procesadas para debugging (usa más espacio).
                            </small>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Configuración
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="restaurarDefault()">
                        <i class="fas fa-undo"></i> Restaurar Valores por Defecto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Información de Ayuda -->
    <div class="help-section">
        <div class="help-card">
            <div class="help-header">
                <h4><i class="fas fa-question-circle"></i> Guía de Configuración</h4>
            </div>
            <div class="help-content">
                <div class="help-item">
                    <div class="help-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="help-text">
                        <h6>Confianza Mínima</h6>
                        <p>Controla qué tan seguro debe estar Tesseract del texto reconocido. Valores más altos = mayor precisión pero puede rechazar texto válido.</p>
                        <p><strong>Recomendado:</strong> 60-80% para documentos de buena calidad</p>
                    </div>
                </div>

                <div class="help-item">
                    <div class="help-icon">
                        <i class="fas fa-signature"></i>
                    </div>
                    <div class="help-text">
                        <h6>Detección de Firmas</h6>
                        <p>Analiza automáticamente si hay firmas presentes y si son legibles. Detecta firmas muy cortas o marcadas como ilegibles.</p>
                        <p><strong>Recomendado:</strong> Activado para control de calidad</p>
                    </div>
                </div>

                <div class="help-item">
                    <div class="help-icon">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                    <div class="help-text">
                        <h6>Tolerancia de Posición</h6>
                        <p>Define qué tan precisa debe ser la posición de las marcas "X" en las celdas. Valores más bajos = mayor precisión requerida.</p>
                        <p><strong>Recomendado:</strong> 3-5 puntos para documentos estándar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="quick-actions">
        <div class="actions-card">
            <div class="actions-header">
                <h4><i class="fas fa-bolt"></i> Acciones Rápidas</h4>
            </div>
            <div class="actions-content">
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="probarConfiguracion()">
                        <i class="fas fa-vial"></i> Probar Configuración Actual
                    </button>
                    <button class="btn btn-success" onclick="exportarConfiguracion()">
                        <i class="fas fa-download"></i> Exportar Configuración
                    </button>
                    <a href="{% url 'ocr_validation:estadisticas' %}" class="btn btn-primary">
                        <i class="fas fa-chart-bar"></i> Ver Estadísticas
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function restaurarDefault() {
    if (confirm('¿Está seguro de que desea restaurar la configuración por defecto?')) {
        // Restaurar valores por defecto
        document.getElementById('tesseract_config').value = '--oem 3 --psm 6';
        document.getElementById('confianza_minima').value = '60.0';
        document.getElementById('tolerancia_posicion_x').value = '5.0';
        document.getElementById('tolerancia_posicion_y').value = '5.0';

        // Desmarcar checkboxes
        document.getElementById('permitir_texto_parcial').checked = false;
        document.getElementById('detectar_firmas').checked = true;
        document.getElementById('procesar_imagenes').checked = true;
        document.getElementById('guardar_imagenes_temporales').checked = false;
    }
}

function probarConfiguracion() {
    alert('Función de prueba de configuración - Se implementará próximamente');
}

function exportarConfiguracion() {
    const configData = {
        tesseract_config: document.getElementById('tesseract_config').value,
        confianza_minima: document.getElementById('confianza_minima').value,
        tolerancia_posicion_x: document.getElementById('tolerancia_posicion_x').value,
        tolerancia_posicion_y: document.getElementById('tolerancia_posicion_y').value,
        permitir_texto_parcial: document.getElementById('permitir_texto_parcial').checked,
        detectar_firmas: document.getElementById('detectar_firmas').checked,
        procesar_imagenes: document.getElementById('procesar_imagenes').checked,
        guardar_imagenes_temporales: document.getElementById('guardar_imagenes_temporales').checked,
        fecha_exportacion: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(configData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `configuracion_ocr_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}