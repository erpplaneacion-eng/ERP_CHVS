{% extends 'base.html' %}
{% load static %}

{% block title %}Estadísticas OCR - ERP CHVS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modules/ocr_validation.css' %}">
{% endblock %}

{% block content %}
<div class="ocr-container">
    <div class="page-header">
        <div class="header-left">
            <h2><i class="fas fa-chart-bar"></i> Estadísticas del Sistema OCR</h2>
            <p>Análisis y métricas del sistema de validación automática</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'ocr_validation:ocr_index' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nueva Validación
            </a>
            <a href="{% url 'ocr_validation:listado' %}" class="btn btn-info">
                <i class="fas fa-list"></i> Ver Validaciones
            </a>
        </div>
    </div>

    <!-- Estadísticas Generales -->
    <div class="stats-overview">
        <div class="overview-card">
            <div class="overview-header">
                <h3><i class="fas fa-tachometer-alt"></i> Resumen General</h3>
            </div>
            <div class="overview-grid">
                <div class="overview-item">
                    <div class="overview-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="overview-content">
                        <h4>{{ estadisticas_generales.total_validaciones }}</h4>
                        <p>Total de Validaciones</p>
                        <small>{{ estadisticas_generales.tasa_exito|floatformat:1 }}% de éxito</small>
                    </div>
                </div>
                <div class="overview-item">
                    <div class="overview-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="overview-content">
                        <h4>{{ estadisticas_generales.validaciones_completadas }}</h4>
                        <p>Procesamientos Exitosos</p>
                        <small>Completados correctamente</small>
                    </div>
                </div>
                <div class="overview-item">
                    <div class="overview-icon warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="overview-content">
                        <h4>{{ estadisticas_generales.validaciones_con_errores }}</h4>
                        <p>Con Errores</p>
                        <small>Documentos con problemas</small>
                    </div>
                </div>
                <div class="overview-item">
                    <div class="overview-icon error">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="overview-content">
                        <h4>{{ estadisticas_errores.total_errores }}</h4>
                        <p>Total de Errores</p>
                        <small>Errores detectados</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Distribución de Errores -->
    <div class="errors-distribution">
        <div class="distribution-card">
            <div class="distribution-header">
                <h4><i class="fas fa-chart-pie"></i> Distribución de Errores por Severidad</h4>
            </div>
            <div class="distribution-content">
                <div class="error-bars">
                    <div class="error-bar">
                        <div class="error-label">
                            <span class="badge badge-danger">Críticos</span>
                            <span class="error-count">{{ estadisticas_errores.errores_criticos }}</span>
                        </div>
                        <div class="error-progress">
                            <div class="progress">
                                <div class="progress-bar bg-danger" style="width: {{ estadisticas_errores.errores_criticos|default:0 }}%">
                                    {{ estadisticas_errores.errores_criticos }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="error-bar">
                        <div class="error-label">
                            <span class="badge badge-warning">Advertencias</span>
                            <span class="error-count">{{ estadisticas_errores.errores_advertencia }}</span>
                        </div>
                        <div class="error-progress">
                            <div class="progress">
                                <div class="progress-bar bg-warning" style="width: {{ estadisticas_errores.errores_advertencia|default:0 }}%">
                                    {{ estadisticas_errores.errores_advertencia }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="error-bar">
                        <div class="error-label">
                            <span class="badge badge-info">Información</span>
                            <span class="error-count">{{ estadisticas_errores.errores_info }}</span>
                        </div>
                        <div class="error-progress">
                            <div class="progress">
                                <div class="progress-bar bg-info" style="width: {{ estadisticas_errores.errores_info|default:0 }}%">
                                    {{ estadisticas_errores.errores_info }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Errores por Tipo -->
    {% if errores_por_tipo %}
    <div class="errors-by-type">
        <div class="type-card">
            <div class="type-header">
                <h4><i class="fas fa-list-ul"></i> Errores Más Comunes</h4>
            </div>
            <div class="type-content">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Tipo de Error</th>
                                <th>Cantidad</th>
                                <th>Porcentaje</th>
                                <th>Tendencia</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for error_tipo in errores_por_tipo %}
                            <tr>
                                <td>{{ error_tipo.tipo_error }}</td>
                                <td class="text-center">
                                    <span class="badge badge-primary">{{ error_tipo.total }}</span>
                                </td>
                                <td class="text-center">
                                    {% widthratio error_tipo.total estadisticas_errores.total_errores 100 %}%
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-arrow-up text-danger"></i>
                                    <small class="text-muted">Recurrente</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Errores por Sede -->
    {% if errores_por_sede %}
    <div class="errors-by-sede">
        <div class="sede-card">
            <div class="sede-header">
                <h4><i class="fas fa-school"></i> Sedes con Más Errores</h4>
            </div>
            <div class="sede-content">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Sede Educativa</th>
                                <th>Total Errores</th>
                                <th>Errores Críticos</th>
                                <th>Última Validación</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sede in errores_por_sede %}
                            <tr>
                                <td>{{ sede.sede_educativa }}</td>
                                <td class="text-center">
                                    <span class="badge {% if sede.total_errores > 10 %}badge-danger{% elif sede.total_errores > 5 %}badge-warning{% else %}badge-success{% endif %}">
                                        {{ sede.total_errores }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    {% if sede.errores_criticos > 0 %}
                                    <span class="badge badge-danger">{{ sede.errores_criticos }}</span>
                                    {% else %}
                                    <span class="badge badge-success">0</span>
                                    {% endif %}
                                </td>
                                <td>{{ sede.fecha_ultima_validacion|date:"d/m/Y" }}</td>
                                <td>
                                    {% if sede.errores_criticos > 0 %}
                                    <span class="badge badge-danger">Requiere Atención</span>
                                    {% elif sede.total_errores > 5 %}
                                    <span class="badge badge-warning">Mejorable</span>
                                    {% else %}
                                    <span class="badge badge-success">Bueno</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Información del Sistema -->
    <div class="system-info-section">
        <div class="info-card">
            <div class="info-header">
                <h4><i class="fas fa-cog"></i> Información del Sistema OCR</h4>
            </div>
            <div class="info-content">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Configuración Actual</h6>
                        <ul class="list-unstyled">
                            <li><strong>Tecnología OCR:</strong> LandingAI ADE</li>
                            <li><strong>Confianza mínima:</strong> {{ configuracion_ocr.confianza_minima }}%</li>
                            <li><strong>Detección de firmas:</strong> {% if configuracion_ocr.detectar_firmas %}Activada{% else %}Desactivada{% endif %}</li>
                            <li><strong>Procesamiento de imágenes:</strong> {% if configuracion_ocr.procesar_imagenes %}Activado{% else %}Desactivado{% endif %}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Características</h6>
                        <ul class="list-unstyled">
                            <li><strong>Validación automática:</strong> Campos manuales del PAE</li>
                            <li><strong>Detección de posición:</strong> Ubicación de marcas "X"</li>
                            <li><strong>Análisis de firmas:</strong> Presencia y legibilidad</li>
                            <li><strong>Control de calidad:</strong> Formatos y consistencia</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="quick-actions">
        <div class="actions-card">
            <div class="actions-header">
                <h4><i class="fas fa-bolt"></i> Acciones Rápidas</h4>
            </div>
            <div class="actions-content">
                <div class="action-buttons">
                    <a href="{% url 'ocr_validation:configuracion' %}" class="btn btn-primary">
                        <i class="fas fa-cog"></i> Configurar OCR
                    </a>
                    <a href="{% url 'ocr_validation:ocr_index' %}" class="btn btn-success">
                        <i class="fas fa-plus"></i> Nueva Validación
                    </a>
                    <button class="btn btn-info" onclick="exportarEstadisticas()">
                        <i class="fas fa-download"></i> Exportar Reporte
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function exportarEstadisticas() {
    // Crear reporte de estadísticas
    const data = {
        fecha_generacion: new Date().toISOString(),
        estadisticas_generales: {{ estadisticas_generales|safe }},
        estadisticas_errores: {{ estadisticas_errores|safe }},
        errores_por_tipo: {{ errores_por_tipo|safe }},
        errores_por_sede: {{ errores_por_sede|safe }}
    };

    // Crear y descargar archivo JSON
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `estadisticas_ocr_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}