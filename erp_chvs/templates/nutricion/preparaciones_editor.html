{% extends 'base.html' %}
{% load static %}

{% block title %}Editor de Preparaciones{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/nutricion/preparaciones_editor.css' %}">
{% endblock %}

{% block content %}
<!-- ========================================
     ENCABEZADO DEL EDITOR
     ======================================== -->
<div class="prep-editor-header">
    <div>
        <h2 style="margin:0;">Preparaciones - Menú {{ menu.menu }}</h2>
        <small style="color: #6b7280;">
            Modalidad: <strong>{{ menu.id_modalidad.modalidad }}</strong> |
            Programa: <strong>{{ menu.id_contrato.programa }}</strong>
        </small>
    </div>
    <a href="{% url 'nutricion:lista_menus' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>

<div class="prep-editor-card" data-menu-id="{{ menu.id_menu }}" id="prepEditorRoot">
    <!-- ========================================
         TOOLBAR PRINCIPAL
         ======================================== -->
    <div class="prep-editor-toolbar">
        <button type="button" id="btnAgregarFila" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle"></i> Agregar preparación
        </button>
        <button type="button" id="btnGuardarCambios" class="btn btn-success btn-sm">
            <i class="bi bi-save"></i> Guardar cambios
        </button>
        <button type="button" id="btnSincronizarPesos" class="btn btn-info btn-sm">
            <i class="bi bi-arrow-repeat"></i> Sincronizar pesos base
        </button>
    </div>

    <!-- ========================================
         TABS DE NIVELES ESCOLARES
         ======================================== -->
    <ul class="nav nav-tabs" id="nivelesTab" role="tablist">
        {% for nivel_data in niveles_data %}
        <li class="nav-item" role="presentation">
            <button
                class="nav-link {% if forloop.first %}active{% endif %}"
                id="tab-{{ nivel_data.nivel.id }}"
                data-bs-toggle="tab"
                data-bs-target="#panel-{{ nivel_data.nivel.id }}"
                type="button"
                role="tab"
                data-nivel-id="{{ nivel_data.nivel.id }}"
            >
                {{ nivel_data.nivel.nombre }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <!-- ========================================
         CONTENIDO DE TABS (POR NIVEL ESCOLAR)
         ======================================== -->
    <div class="tab-content" id="nivelesTabContent" style="padding-top: 20px;">
        {% for nivel_data in niveles_data %}
        <div
            class="tab-pane fade {% if forloop.first %}show active{% endif %}"
            id="panel-{{ nivel_data.nivel.id }}"
            role="tabpanel"
            data-nivel-id="{{ nivel_data.nivel.id }}"
            data-id-analisis="{{ nivel_data.id_analisis }}"
        >
            <!-- Toolbar de optimización (copiar, optimizar, comparar) -->
            <div class="nivel-toolbar">
                <div class="nivel-toolbar-section">
                    <button type="button" class="btn btn-outline-primary btn-sm btn-copiar-pesos"
                            data-nivel-id="{{ nivel_data.nivel.id }}"
                            title="Copiar estos pesos a otros niveles">
                        <i class="bi bi-files"></i> Copiar a otros niveles
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm btn-optimizar-pesos"
                            data-nivel-id="{{ nivel_data.nivel.id }}"
                            title="Optimizar automáticamente para cumplir metas">
                        <i class="bi bi-lightning-charge"></i> Optimizar
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm btn-comparar-minuta"
                            data-nivel-id="{{ nivel_data.nivel.id }}"
                            title="Comparar con Minuta Patrón">
                        <i class="bi bi-clipboard-check"></i> Comparar
                    </button>
                </div>
                <div class="nivel-toolbar-section">
                    <!-- Sección de herramientas adicionales -->
                </div>
            </div>

            <!-- Tabla de ingredientes con pesos editables -->
            <div class="tabla-container">
                <table class="tabla-ingredientes">
                    <thead>
                        <tr>
                            <th class="col-preparacion">Preparación</th>
                            <th class="col-ingrediente">Ingrediente ICBF</th>
                            <th class="col-grupo">Grupo</th>
                            <th class="col-rango">Rango (g)</th>
                            <th class="col-peso">Peso neto (g)</th>
                            <th class="col-acciones">Estado</th>
                        </tr>
                    </thead>
                    <tbody class="tbody-ingredientes" data-nivel-id="{{ nivel_data.nivel.id }}">
                        {% for fila in nivel_data.filas %}
                        <tr
                            data-id-preparacion="{{ fila.id_preparacion }}"
                            data-id-ingrediente="{{ fila.id_ingrediente }}"
                        >
                            <td class="col-preparacion">
                                <strong>{{ fila.preparacion }}</strong>
                            </td>
                            <td class="col-ingrediente">
                                <span style="color: #6b7280; font-size: 11px;">{{ fila.codigo_icbf }}</span><br>
                                {{ fila.ingrediente }}
                            </td>
                            <td class="col-grupo">{{ fila.grupo }}</td>
                            <td class="col-rango">
                                {% if fila.minimo != None and fila.maximo != None %}
                                <span class="badge-rango">{{ fila.minimo|floatformat:0 }} - {{ fila.maximo|floatformat:0 }}</span>
                                {% elif fila.minimo != None %}
                                <span class="badge-rango">{{ fila.minimo|floatformat:0 }}+</span>
                                {% else %}
                                <span style="color: #9ca3af; font-size: 11px;">Sin rango</span>
                                {% endif %}
                            </td>
                            <td class="col-peso">
                                <div class="peso-control-container">                                    
                                    <!-- Input numérico -->
                                    <input
                                        type="number"
                                        class="input-peso"
                                        value="{{ fila.peso_neto|stringformat:".1f" }}"
                                        step="0.1"
                                        min="0"
                                        data-minimo="{{ fila.minimo|default:'' }}"
                                        data-maximo="{{ fila.maximo|default:'' }}"
                                        data-parte-comestible="{{ fila.parte_comestible }}"
                                        data-id-ingrediente="{{ fila.id_ingrediente }}"
                                        data-calorias="{{ fila.calorias|default:0 }}"
                                        data-proteina="{{ fila.proteina|default:0 }}"
                                        data-grasa="{{ fila.grasa|default:0 }}"
                                        data-cho="{{ fila.cho|default:0 }}"
                                        title="Calorías: {{ fila.calorias|floatformat:1 }} kcal | Proteína: {{ fila.proteina|floatformat:1 }}g | Grasa: {{ fila.grasa|floatformat:1 }}g | CHO: {{ fila.cho|floatformat:1 }}g"
                                    />
                                </div>
                            </td>
                            <td class="col-acciones">
                                <span class="badge-estado ok"
                                      data-bs-toggle="tooltip"
                                      data-bs-placement="left"
                                      title="Dentro del rango permitido">
                                    OK
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Panel de totales nutricionales con semaforización -->
            <div class="panel-totales">
                <h5>
                    <i class="bi bi-bar-chart-fill"></i>
                    Análisis Nutricional - {{ nivel_data.nivel.nombre }}
                </h5>
                <div class="grid-nutrientes">
                    <!-- Calorías -->
                    <div class="nutriente-card {{ nivel_data.estados.calorias }}" data-nutriente="calorias">
                        <div class="nutriente-label">Calorías</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.calorias|floatformat:1 }}</span> kcal
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.calorias }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.calorias|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.calorias|floatformat:1 }} kcal
                        </div>
                    </div>

                    <!-- Proteína -->
                    <div class="nutriente-card {{ nivel_data.estados.proteina }}" data-nutriente="proteina">
                        <div class="nutriente-label">Proteína</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.proteina|floatformat:1 }}</span> g
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.proteina }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.proteina|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.proteina|floatformat:1 }} g
                        </div>
                    </div>

                    <!-- Grasa -->
                    <div class="nutriente-card {{ nivel_data.estados.grasa }}" data-nutriente="grasa">
                        <div class="nutriente-label">Grasa</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.grasa|floatformat:1 }}</span> g
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.grasa }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.grasa|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.grasa|floatformat:1 }} g
                        </div>
                    </div>

                    <!-- Carbohidratos -->
                    <div class="nutriente-card {{ nivel_data.estados.cho }}" data-nutriente="cho">
                        <div class="nutriente-label">Carbohidratos</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.cho|floatformat:1 }}</span> g
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.cho }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.cho|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.cho|floatformat:1 }} g
                        </div>
                    </div>

                    <!-- Calcio -->
                    <div class="nutriente-card {{ nivel_data.estados.calcio }}" data-nutriente="calcio">
                        <div class="nutriente-label">Calcio</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.calcio|floatformat:1 }}</span> mg
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.calcio }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.calcio|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.calcio|floatformat:1 }} mg
                        </div>
                    </div>

                    <!-- Hierro -->
                    <div class="nutriente-card {{ nivel_data.estados.hierro }}" data-nutriente="hierro">
                        <div class="nutriente-label">Hierro</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.hierro|floatformat:1 }}</span> mg
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.hierro }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.hierro|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.hierro|floatformat:1 }} mg
                        </div>
                    </div>

                    <!-- Sodio -->
                    <div class="nutriente-card {{ nivel_data.estados.sodio }}" data-nutriente="sodio">
                        <div class="nutriente-label">Sodio</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.sodio|floatformat:1 }}</span> mg
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.sodio }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.sodio|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.sodio|floatformat:1 }} mg
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ========================================
     MODAL PARA AGREGAR INGREDIENTE
     ======================================== -->
<div class="modal fade" id="modalAgregarIngrediente" tabindex="-1" aria-labelledby="modalAgregarIngredienteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarIngredienteLabel">
                    <i class="bi bi-plus-circle"></i> Agregar Preparación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarIngrediente">
                    <div class="mb-3">
                        <label for="selectPreparacion" class="form-label">Preparación *</label>
                        <select class="form-select" id="selectPreparacion" required>
                            <option value="">Seleccione una preparación...</option>
                        </select>
                        <small class="form-text text-muted">Preparación a la que se agregará el ingrediente</small>
                    </div>

                    <div class="mb-3">
                        <label for="selectIngrediente" class="form-label">Ingrediente ICBF *</label>
                        <select class="form-select" id="selectIngrediente" required>
                            <option value="">Seleccione un ingrediente...</option>
                        </select>
                        <small class="form-text text-muted">Busque por nombre o código ICBF</small>
                    </div>

                    <div class="mb-3">
                        <label for="inputPesoInicial" class="form-label">Peso inicial (gramos)</label>
                        <input type="number" class="form-control" id="inputPesoInicial"
                               value="100" min="1" step="0.1">
                        <small class="form-text text-muted">Peso base que se copiará a todos los niveles escolares</small>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle"></i>
                        El ingrediente se agregará a <strong>todos los niveles escolares</strong> con el peso especificado.
                        Podrás ajustar los pesos individuales después.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarAgregarIngrediente">
                    <i class="bi bi-check-circle"></i> Agregar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================
     DATOS JSON PARA JAVASCRIPT
     Datos embebidos que serán leídos por preparaciones_editor.js
     ======================================== -->
<script id="niveles-data" type="application/json">{{ niveles_json|safe }}</script>
<script id="ingredientes-catalogo" type="application/json">{{ ingredientes_json|safe }}</script>
<script id="preparaciones-catalogo" type="application/json">{{ preparaciones_json|safe }}</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/nutricion/preparaciones_editor.js' %}"></script>
{% endblock %}


