{% extends 'base.html' %}
{% load static %}

{% block title %}Editor de Preparaciones{% endblock %}

{% block extra_css %}
<style>
    .prep-editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .prep-editor-card {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    /* Tabs de niveles escolares */
    .nav-tabs {
        border-bottom: 2px solid #e5e7eb;
    }
    .nav-tabs .nav-link {
        border: none;
        color: #6b7280;
        font-weight: 500;
        padding: 10px 20px;
        margin-bottom: -2px;
    }
    .nav-tabs .nav-link.active {
        color: #2563eb;
        border-bottom: 2px solid #2563eb;
    }
    .nav-tabs .nav-link:hover {
        border-bottom: 2px solid #93c5fd;
    }

    /* Toolbar */
    .prep-editor-toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
    }

    /* Tabla de ingredientes */
    .tabla-ingredientes {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 13px;
    }
    .tabla-ingredientes thead {
        background: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .tabla-ingredientes th {
        padding: 10px 8px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        white-space: nowrap;
    }
    .tabla-ingredientes td {
        padding: 8px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
    }
    .tabla-ingredientes tbody tr:hover {
        background: #f9fafb;
    }

    /* Inputs */
    .input-peso {
        width: 100px;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        text-align: right;
        font-family: monospace;
    }
    .input-peso:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .input-peso.fuera-rango {
        border-color: #dc2626;
        background: #fef2f2;
    }

    /* Panel de totales */
    .panel-totales {
        background: #f8fafc;
        border-radius: 8px;
        padding: 16px;
        margin-top: 20px;
    }
    .panel-totales h5 {
        margin: 0 0 12px 0;
        font-size: 15px;
        font-weight: 600;
    }
    .grid-nutrientes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
    }
    .nutriente-card {
        background: #fff;
        padding: 12px;
        border-radius: 6px;
        border-left: 4px solid #d1d5db;
    }
    .nutriente-card.optimo {
        border-left-color: #10b981;
    }
    .nutriente-card.aceptable {
        border-left-color: #f59e0b;
    }
    .nutriente-card.alto {
        border-left-color: #ef4444;
    }
    .nutriente-label {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: #6b7280;
        margin-bottom: 4px;
    }
    .nutriente-valor {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
        font-family: monospace;
    }
    .nutriente-porcentaje {
        font-size: 13px;
        font-weight: 600;
        margin-top: 4px;
    }
    .nutriente-porcentaje.optimo { color: #10b981; }
    .nutriente-porcentaje.aceptable { color: #f59e0b; }
    .nutriente-porcentaje.alto { color: #ef4444; }
    .nutriente-requerimiento {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }

    /* Badges de rango */
    .badge-rango {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        background: #e5e7eb;
        color: #374151;
        white-space: nowrap;
    }
    .badge-estado {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
    }
    .badge-estado.ok {
        background: #d1fae5;
        color: #065f46;
    }
    .badge-estado.fuera {
        background: #fee2e2;
        color: #991b1b;
    }

    /* Columnas de tabla */
    .col-preparacion { width: 200px; }
    .col-ingrediente { width: 250px; }
    .col-grupo { width: 140px; }
    .col-rango { width: 120px; }
    .col-peso { width: 220px; }
    .col-acciones { width: 80px; text-align: center; }

    /* Control de peso con slider */
    .peso-control-container {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    /* Slider personalizado */
    .slider-container {
        position: relative;
        padding: 0 4px;
    }
    .slider-peso {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        background: linear-gradient(to right,
            #10b981 0%,
            #10b981 33%,
            #f59e0b 33%,
            #f59e0b 66%,
            #ef4444 66%,
            #ef4444 100%);
        cursor: pointer;
    }

    /* Thumb del slider - WebKit (Chrome, Safari) */
    .slider-peso::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #2563eb;
        cursor: pointer;
        border: 3px solid #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .slider-peso::-webkit-slider-thumb:hover {
        transform: scale(1.15);
        box-shadow: 0 3px 8px rgba(0,0,0,0.35);
    }
    .slider-peso:active::-webkit-slider-thumb {
        transform: scale(1.25);
    }

    /* Thumb del slider - Firefox */
    .slider-peso::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #2563eb;
        cursor: pointer;
        border: 3px solid #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .slider-peso::-moz-range-thumb:hover {
        transform: scale(1.15);
        box-shadow: 0 3px 8px rgba(0,0,0,0.35);
    }
    .slider-peso:active::-moz-range-thumb {
        transform: scale(1.25);
    }

    /* Track del slider - Firefox */
    .slider-peso::-moz-range-track {
        height: 6px;
        border-radius: 3px;
    }

    /* Labels del slider */
    .slider-labels {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        color: #9ca3af;
        margin-top: 2px;
        padding: 0 4px;
    }
    .slider-label-min, .slider-label-max {
        font-weight: 600;
    }

    /* Input de peso mejorado */
    .input-peso {
        width: 100%;
        padding: 6px 10px;
        border: 2px solid #d1d5db;
        border-radius: 6px;
        text-align: center;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        font-weight: 600;
        transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
    }
    .input-peso:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        background: #f9fafb;
    }
    .input-peso.fuera-rango {
        border-color: #dc2626;
        background: #fef2f2;
        color: #991b1b;
    }
    .input-peso.en-rango {
        border-color: #10b981;
        background: #f0fdf4;
    }

    /* Scrollable table container */
    .tabla-container {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }

    /* Animaciones */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    /* Efectos hover mejorados */
    .tabla-ingredientes tbody tr {
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }
    .tabla-ingredientes tbody tr:hover {
        background: #f9fafb;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* Indicador de guardando */
    .guardando-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s ease;
    }
    .guardando-card {
        background: white;
        padding: 30px 50px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        text-align: center;
    }
    .guardando-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e5e7eb;
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 15px auto;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Mejora visual de nutriente-card con animación */
    .nutriente-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .nutriente-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Botones del toolbar mejorados */
    .prep-editor-toolbar button {
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .prep-editor-toolbar button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .prep-editor-toolbar button:active:not(:disabled) {
        transform: translateY(0);
    }

    /* Variables CSS para slider */
    .slider-peso {
        --thumb-color: #2563eb;
    }

    /* Actualizar thumb con variable */
    .slider-peso::-webkit-slider-thumb {
        background: var(--thumb-color, #2563eb);
    }
    .slider-peso::-moz-range-thumb {
        background: var(--thumb-color, #2563eb);
    }

    /* Toolbar de nivel */
    .nivel-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 16px;
    }
    .nivel-toolbar-section {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .nivel-toolbar button {
        font-size: 13px;
        padding: 6px 12px;
        white-space: nowrap;
    }

    /* Panel de sugerencias */
    .panel-sugerencias {
        background: #fffbeb;
        border: 2px solid #fbbf24;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        animation: slideDown 0.3s ease-out;
    }
    .sugerencias-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    .sugerencias-header h6 {
        margin: 0;
        color: #92400e;
        font-size: 14px;
        font-weight: 600;
    }
    .sugerencias-header h6 i {
        color: #f59e0b;
        margin-right: 6px;
    }
    .btn-close-sugerencias {
        background: none;
        border: none;
        font-size: 24px;
        line-height: 1;
        color: #92400e;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    .btn-close-sugerencias:hover {
        background-color: rgba(146, 64, 14, 0.1);
    }
    .sugerencias-content {
        color: #78350f;
        font-size: 13px;
    }
    .sugerencia-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px;
        background: #fff;
        border-left: 3px solid #f59e0b;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    .sugerencia-item:last-child {
        margin-bottom: 0;
    }
    .sugerencia-icon {
        font-size: 18px;
        color: #f59e0b;
        flex-shrink: 0;
    }
    .sugerencia-text {
        flex: 1;
    }
    .sugerencia-text strong {
        color: #92400e;
        display: block;
        margin-bottom: 4px;
    }
    .sugerencia-accion {
        margin-top: 6px;
    }
    .sugerencia-accion button {
        font-size: 11px;
        padding: 3px 10px;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="prep-editor-header">
    <div>
        <h2 style="margin:0;">Preparaciones - Menú {{ menu.menu }}</h2>
        <small style="color: #6b7280;">
            Modalidad: <strong>{{ menu.id_modalidad.modalidad }}</strong> |
            Programa: <strong>{{ menu.id_contrato.programa }}</strong>
        </small>
    </div>
    <a href="{% url 'nutricion:lista_menus' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>

<div class="prep-editor-card" data-menu-id="{{ menu.id_menu }}" id="prepEditorRoot">
    <!-- Toolbar -->
    <div class="prep-editor-toolbar">
        <button type="button" id="btnAgregarFila" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle"></i> Agregar ingrediente
        </button>
        <button type="button" id="btnGuardarCambios" class="btn btn-success btn-sm">
            <i class="bi bi-save"></i> Guardar cambios
        </button>
        <button type="button" id="btnSincronizarPesos" class="btn btn-info btn-sm">
            <i class="bi bi-arrow-repeat"></i> Sincronizar pesos base
        </button>
        <div style="flex: 1;"></div>
        <button type="button" id="btnRecalcular" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-calculator"></i> Recalcular
        </button>
    </div>

    <!-- Tabs de niveles escolares -->
    <ul class="nav nav-tabs" id="nivelesTab" role="tablist">
        {% for nivel_data in niveles_data %}
        <li class="nav-item" role="presentation">
            <button
                class="nav-link {% if forloop.first %}active{% endif %}"
                id="tab-{{ nivel_data.nivel.id }}"
                data-bs-toggle="tab"
                data-bs-target="#panel-{{ nivel_data.nivel.id }}"
                type="button"
                role="tab"
                data-nivel-id="{{ nivel_data.nivel.id }}"
            >
                {{ nivel_data.nivel.nombre }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <!-- Contenido de tabs -->
    <div class="tab-content" id="nivelesTabContent" style="padding-top: 20px;">
        {% for nivel_data in niveles_data %}
        <div
            class="tab-pane fade {% if forloop.first %}show active{% endif %}"
            id="panel-{{ nivel_data.nivel.id }}"
            role="tabpanel"
            data-nivel-id="{{ nivel_data.nivel.id }}"
            data-id-analisis="{{ nivel_data.id_analisis }}"
        >
            <!-- Toolbar de optimización específica del nivel -->
            <div class="nivel-toolbar">
                <div class="nivel-toolbar-section">
                    <button type="button" class="btn btn-outline-primary btn-sm btn-copiar-pesos"
                            data-nivel-id="{{ nivel_data.nivel.id }}"
                            title="Copiar estos pesos a otros niveles">
                        <i class="bi bi-files"></i> Copiar a otros niveles
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm btn-optimizar-pesos"
                            data-nivel-id="{{ nivel_data.nivel.id }}"
                            title="Optimizar automáticamente para cumplir metas">
                        <i class="bi bi-lightning-charge"></i> Optimizar
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm btn-comparar-minuta"
                            data-nivel-id="{{ nivel_data.nivel.id }}"
                            title="Comparar con Minuta Patrón">
                        <i class="bi bi-clipboard-check"></i> Comparar
                    </button>
                </div>
                <div class="nivel-toolbar-section">
                    <button type="button" class="btn btn-outline-secondary btn-sm btn-sugerencias"
                            data-nivel-id="{{ nivel_data.nivel.id }}"
                            title="Ver sugerencias de ajuste">
                        <i class="bi bi-lightbulb"></i> Sugerencias
                    </button>
                </div>
            </div>

            <!-- Panel de sugerencias (oculto por defecto) -->
            <div class="panel-sugerencias" id="sugerencias-{{ nivel_data.nivel.id }}" style="display: none;">
                <div class="sugerencias-header">
                    <h6><i class="bi bi-lightbulb-fill"></i> Sugerencias de Optimización</h6>
                    <button type="button" class="btn-close-sugerencias" aria-label="Cerrar">×</button>
                </div>
                <div class="sugerencias-content">
                    <!-- Se llenará dinámicamente con JavaScript -->
                </div>
            </div>

            <!-- Tabla de ingredientes -->
            <div class="tabla-container">
                <table class="tabla-ingredientes">
                    <thead>
                        <tr>
                            <th class="col-preparacion">Preparación</th>
                            <th class="col-ingrediente">Ingrediente ICBF</th>
                            <th class="col-grupo">Grupo</th>
                            <th class="col-rango">Rango (g)</th>
                            <th class="col-peso">Peso neto (g)</th>
                            <th class="col-acciones">Estado</th>
                        </tr>
                    </thead>
                    <tbody class="tbody-ingredientes" data-nivel-id="{{ nivel_data.nivel.id }}">
                        {% for fila in nivel_data.filas %}
                        <tr
                            data-id-preparacion="{{ fila.id_preparacion }}"
                            data-id-ingrediente="{{ fila.id_ingrediente }}"
                        >
                            <td class="col-preparacion">
                                <strong>{{ fila.preparacion }}</strong>
                            </td>
                            <td class="col-ingrediente">
                                <span style="color: #6b7280; font-size: 11px;">{{ fila.codigo_icbf }}</span><br>
                                {{ fila.ingrediente }}
                            </td>
                            <td class="col-grupo">{{ fila.grupo }}</td>
                            <td class="col-rango">
                                {% if fila.minimo and fila.maximo %}
                                <span class="badge-rango">{{ fila.minimo|floatformat:0 }} - {{ fila.maximo|floatformat:0 }}</span>
                                {% else %}
                                <span style="color: #9ca3af; font-size: 11px;">Sin rango</span>
                                {% endif %}
                            </td>
                            <td class="col-peso">
                                <div class="peso-control-container">
                                    {% if fila.minimo and fila.maximo %}
                                    <!-- Slider visual con rango -->
                                    <div class="slider-container">
                                        <input
                                            type="range"
                                            class="slider-peso"
                                            min="{{ fila.minimo }}"
                                            max="{{ fila.maximo }}"
                                            step="1"
                                            value="{{ fila.peso_neto|floatformat:0 }}"
                                            data-minimo="{{ fila.minimo }}"
                                            data-maximo="{{ fila.maximo }}"
                                            data-id-ingrediente="{{ fila.id_ingrediente }}"
                                        />
                                        <div class="slider-labels">
                                            <span class="slider-label-min">{{ fila.minimo|floatformat:0 }}</span>
                                            <span class="slider-label-max">{{ fila.maximo|floatformat:0 }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <!-- Input numérico -->
                                    <input
                                        type="number"
                                        class="input-peso"
                                        value="{{ fila.peso_neto|floatformat:1 }}"
                                        step="0.1"
                                        min="0"
                                        data-minimo="{{ fila.minimo|default:'' }}"
                                        data-maximo="{{ fila.maximo|default:'' }}"
                                        data-parte-comestible="{{ fila.parte_comestible }}"
                                        data-id-ingrediente="{{ fila.id_ingrediente }}"
                                        data-calorias="{{ fila.calorias|default:0 }}"
                                        data-proteina="{{ fila.proteina|default:0 }}"
                                        data-grasa="{{ fila.grasa|default:0 }}"
                                        data-cho="{{ fila.cho|default:0 }}"
                                        title="Calorías: {{ fila.calorias|floatformat:1 }} kcal | Proteína: {{ fila.proteina|floatformat:1 }}g | Grasa: {{ fila.grasa|floatformat:1 }}g | CHO: {{ fila.cho|floatformat:1 }}g"
                                    />
                                </div>
                            </td>
                            <td class="col-acciones">
                                <span class="badge-estado ok"
                                      data-bs-toggle="tooltip"
                                      data-bs-placement="left"
                                      title="Dentro del rango permitido">
                                    OK
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Panel de totales nutricionales -->
            <div class="panel-totales">
                <h5>
                    <i class="bi bi-bar-chart-fill"></i>
                    Análisis Nutricional - {{ nivel_data.nivel.nombre }}
                </h5>
                <div class="grid-nutrientes">
                    <!-- Calorías -->
                    <div class="nutriente-card {{ nivel_data.estados.calorias }}" data-nutriente="calorias">
                        <div class="nutriente-label">Calorías</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.calorias|floatformat:1 }}</span> kcal
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.calorias }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.calorias|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.calorias|floatformat:1 }} kcal
                        </div>
                    </div>

                    <!-- Proteína -->
                    <div class="nutriente-card {{ nivel_data.estados.proteina }}" data-nutriente="proteina">
                        <div class="nutriente-label">Proteína</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.proteina|floatformat:1 }}</span> g
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.proteina }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.proteina|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.proteina|floatformat:1 }} g
                        </div>
                    </div>

                    <!-- Grasa -->
                    <div class="nutriente-card {{ nivel_data.estados.grasa }}" data-nutriente="grasa">
                        <div class="nutriente-label">Grasa</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.grasa|floatformat:1 }}</span> g
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.grasa }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.grasa|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.grasa|floatformat:1 }} g
                        </div>
                    </div>

                    <!-- Carbohidratos -->
                    <div class="nutriente-card {{ nivel_data.estados.cho }}" data-nutriente="cho">
                        <div class="nutriente-label">Carbohidratos</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.cho|floatformat:1 }}</span> g
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.cho }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.cho|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.cho|floatformat:1 }} g
                        </div>
                    </div>

                    <!-- Calcio -->
                    <div class="nutriente-card {{ nivel_data.estados.calcio }}" data-nutriente="calcio">
                        <div class="nutriente-label">Calcio</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.calcio|floatformat:1 }}</span> mg
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.calcio }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.calcio|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.calcio|floatformat:1 }} mg
                        </div>
                    </div>

                    <!-- Hierro -->
                    <div class="nutriente-card {{ nivel_data.estados.hierro }}" data-nutriente="hierro">
                        <div class="nutriente-label">Hierro</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.hierro|floatformat:1 }}</span> mg
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.hierro }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.hierro|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.hierro|floatformat:1 }} mg
                        </div>
                    </div>

                    <!-- Sodio -->
                    <div class="nutriente-card {{ nivel_data.estados.sodio }}" data-nutriente="sodio">
                        <div class="nutriente-label">Sodio</div>
                        <div class="nutriente-valor">
                            <span class="valor-actual">{{ nivel_data.totales.sodio|floatformat:1 }}</span> mg
                        </div>
                        <div class="nutriente-porcentaje {{ nivel_data.estados.sodio }}">
                            <span class="porcentaje-actual">{{ nivel_data.porcentajes.sodio|floatformat:1 }}</span>%
                        </div>
                        <div class="nutriente-requerimiento">
                            Meta: {{ nivel_data.requerimientos.sodio|floatformat:1 }} mg
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para agregar ingrediente -->
<div class="modal fade" id="modalAgregarIngrediente" tabindex="-1" aria-labelledby="modalAgregarIngredienteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarIngredienteLabel">
                    <i class="bi bi-plus-circle"></i> Agregar Ingrediente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarIngrediente">
                    <div class="mb-3">
                        <label for="selectPreparacion" class="form-label">Preparación *</label>
                        <select class="form-select" id="selectPreparacion" required>
                            <option value="">Seleccione una preparación...</option>
                        </select>
                        <small class="form-text text-muted">Preparación a la que se agregará el ingrediente</small>
                    </div>

                    <div class="mb-3">
                        <label for="selectIngrediente" class="form-label">Ingrediente ICBF *</label>
                        <select class="form-select" id="selectIngrediente" required>
                            <option value="">Seleccione un ingrediente...</option>
                        </select>
                        <small class="form-text text-muted">Busque por nombre o código ICBF</small>
                    </div>

                    <div class="mb-3">
                        <label for="inputPesoInicial" class="form-label">Peso inicial (gramos)</label>
                        <input type="number" class="form-control" id="inputPesoInicial"
                               value="100" min="1" step="0.1">
                        <small class="form-text text-muted">Peso base que se copiará a todos los niveles escolares</small>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle"></i>
                        El ingrediente se agregará a <strong>todos los niveles escolares</strong> con el peso especificado.
                        Podrás ajustar los pesos individuales después.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarAgregarIngrediente">
                    <i class="bi bi-check-circle"></i> Agregar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Data para JavaScript -->
<script id="niveles-data" type="application/json">{{ niveles_json|safe }}</script>
<script id="ingredientes-catalogo" type="application/json">{{ ingredientes_json|safe }}</script>
<script id="preparaciones-catalogo" type="application/json">{{ preparaciones_json|safe }}</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/nutricion/preparaciones_editor.js' %}"></script>
{% endblock %}
