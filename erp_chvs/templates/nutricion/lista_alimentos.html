{% extends 'base.html' %}
{% load static %}
{% load l10n %}

{% block title %}Lista de Alimentos ICBF{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/nutricion/inline_styles.css' %}">
{% endblock %}

{% block content %}
    <h1>Lista de Alimentos ICBF 2018</h1>
    <p>Gestión de alimentos según la tabla del Instituto Colombiano de Bienestar Familiar.</p>

    <!-- Mensajes de Django -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {% if message.tags == 'success' %}
                <i class="fas fa-check-circle"></i>
            {% elif message.tags == 'error' %}
                <i class="fas fa-exclamation-circle"></i>
            {% elif message.tags == 'warning' %}
                <i class="fas fa-exclamation-triangle"></i>
            {% else %}
                <i class="fas fa-info-circle"></i>
            {% endif %}
            {{ message }}
            <button type="button" class="close" onclick="this.parentElement.remove()">
                <span>&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Barra de búsqueda -->
    <div class="search-container">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar por nombre, código, energía, proteína... (Enter para buscar)" autocomplete="off" value="{{ search_query|default:'' }}">
            <button id="clearSearch" class="btn-clear-search {% if search_query %}show{% endif %}" title="Limpiar búsqueda">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="search-results-info">
            <span id="searchResultsCount">
                {% if search_query %}
                    Resultados para "<span class="highlight">{{ search_query }}</span>"
                {% else %}
                    Mostrando todos los alimentos
                {% endif %}
            </span>
        </div>
    </div>

    <div class="actions-bar">
        <!-- Botón para Añadir Nuevo Alimento con Modal -->
        <button id="add-alimento-btn" class="btn btn-success" data-create-url="{% url 'nutricion:lista_alimentos' %}">
            <i class="fas fa-plus"></i> Añadir Alimento
        </button>
    </div>
<!-- ========================================================== -->
<!-- TABLA DE RESULTADOS                                        -->
<!-- ========================================================== -->
<div class="table-container">
    <table class="alimentos-table">
        <thead>
            <tr>
                <th>Nombre del Alimento</th>
                <th>Energía (kcal)</th>
                <th>Proteína (g)</th>
                <th>Lípidos (g)</th>
                <th>Carbohidratos (g)</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for alimento in alimentos_page %}
            <tr>
                <td>{{ alimento.nombre_del_alimento }}</td>
                <td>{{ alimento.energia_kcal }}</td>
                <td>{{ alimento.proteina_g }}</td>
                <td>{{ alimento.lipidos_g }}</td>
                <td>{{ alimento.carbohidratos_totales_g }}</td>
                <td>
                    {% localize off %}
                    <button class="btn btn-sm btn-info view-alimento-btn"
                            title="Ver detalles"
                            data-codigo="{{ alimento.codigo }}"
                            data-nombre="{{ alimento.nombre_del_alimento }}"
                            data-parte-analizada="{{ alimento.parte_analizada|default:'N/A' }}"
                            data-componente="{{ alimento.id_componente.componente|default:'Sin componente' }}"
                            data-humedad="{{ alimento.humedad_g }}"
                            data-energia-kcal="{{ alimento.energia_kcal }}"
                            data-energia-kj="{{ alimento.energia_kj }}"
                            data-proteina="{{ alimento.proteina_g }}"
                            data-lipidos="{{ alimento.lipidos_g }}"
                            data-carbohidratos-totales="{{ alimento.carbohidratos_totales_g }}"
                            data-carbohidratos-disponibles="{{ alimento.carbohidratos_disponibles_g|default:'N/A' }}"
                            data-fibra-dietaria="{{ alimento.fibra_dietaria_g|default:'N/A' }}"
                            data-cenizas="{{ alimento.cenizas_g|default:'N/A' }}"
                            data-calcio="{{ alimento.calcio_mg|default:'N/A' }}"
                            data-hierro="{{ alimento.hierro_mg|default:'N/A' }}"
                            data-sodio="{{ alimento.sodio_mg|default:'N/A' }}"
                            data-fosforo="{{ alimento.fosforo_mg|default:'N/A' }}"
                            data-yodo="{{ alimento.yodo_mg|default:'N/A' }}"
                            data-zinc="{{ alimento.zinc_mg|default:'N/A' }}"
                            data-magnesio="{{ alimento.magnesio_mg|default:'N/A' }}"
                            data-potasio="{{ alimento.potasio_mg|default:'N/A' }}"
                            data-tiamina="{{ alimento.tiamina_mg|default:'N/A' }}"
                            data-riboflavina="{{ alimento.riboflavina_mg|default:'N/A' }}"
                            data-niacina="{{ alimento.niacina_mg|default:'N/A' }}"
                            data-folatos="{{ alimento.folatos_mcg|default:'N/A' }}"
                            data-vitamina-b12="{{ alimento.vitamina_b12_mcg|default:'N/A' }}"
                            data-vitamina-c="{{ alimento.vitamina_c_mg|default:'N/A' }}"
                            data-vitamina-a="{{ alimento.vitamina_a_er|default:'N/A' }}"
                            data-grasa-saturada="{{ alimento.grasa_saturada_g|default:'N/A' }}"
                            data-grasa-monoinsaturada="{{ alimento.grasa_monoinsaturada_g|default:'N/A' }}"
                            data-grasa-poliinsaturada="{{ alimento.grasa_poliinsaturada_g|default:'N/A' }}"
                            data-colesterol="{{ alimento.colesterol_mg|default:'N/A' }}"
                            data-parte-comestible="{{ alimento.parte_comestible_field|default:'N/A' }}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-warning edit-alimento-btn"
                            title="Editar"
                            data-codigo="{{ alimento.codigo }}"
                            data-nombre="{{ alimento.nombre_del_alimento }}"
                            data-parte-analizada="{{ alimento.parte_analizada|default:'' }}"
                            data-id-componente="{{ alimento.id_componente_id|default:'' }}"
                            data-humedad="{{ alimento.humedad_g }}"
                            data-energia-kcal="{{ alimento.energia_kcal }}"
                            data-energia-kj="{{ alimento.energia_kj }}"
                            data-proteina="{{ alimento.proteina_g }}"
                            data-lipidos="{{ alimento.lipidos_g }}"
                            data-carbohidratos-totales="{{ alimento.carbohidratos_totales_g }}"
                            data-carbohidratos-disponibles="{{ alimento.carbohidratos_disponibles_g|default:'' }}"
                            data-fibra-dietaria="{{ alimento.fibra_dietaria_g|default:'' }}"
                            data-cenizas="{{ alimento.cenizas_g|default:'' }}"
                            data-calcio="{{ alimento.calcio_mg|default:'' }}"
                            data-hierro="{{ alimento.hierro_mg|default:'' }}"
                            data-sodio="{{ alimento.sodio_mg|default:'' }}"
                            data-fosforo="{{ alimento.fosforo_mg|default:'' }}"
                            data-yodo="{{ alimento.yodo_mg|default:'' }}"
                            data-zinc="{{ alimento.zinc_mg|default:'' }}"
                            data-magnesio="{{ alimento.magnesio_mg|default:'' }}"
                            data-potasio="{{ alimento.potasio_mg|default:'' }}"
                            data-tiamina="{{ alimento.tiamina_mg|default:'' }}"
                            data-riboflavina="{{ alimento.riboflavina_mg|default:'' }}"
                            data-niacina="{{ alimento.niacina_mg|default:'' }}"
                            data-folatos="{{ alimento.folatos_mcg|default:'' }}"
                            data-vitamina-b12="{{ alimento.vitamina_b12_mcg|default:'' }}"
                            data-vitamina-c="{{ alimento.vitamina_c_mg|default:'' }}"
                            data-vitamina-a="{{ alimento.vitamina_a_er|default:'' }}"
                            data-grasa-saturada="{{ alimento.grasa_saturada_g|default:'' }}"
                            data-grasa-monoinsaturada="{{ alimento.grasa_monoinsaturada_g|default:'' }}"
                            data-grasa-poliinsaturada="{{ alimento.grasa_poliinsaturada_g|default:'' }}"
                            data-colesterol="{{ alimento.colesterol_mg|default:'' }}"
                            data-parte-comestible="{{ alimento.parte_comestible_field|default:'' }}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-alimento-btn"
                            title="Eliminar"
                            data-codigo="{{ alimento.codigo }}"
                            data-nombre="{{ alimento.nombre_del_alimento }}">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% endlocalize %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">
                    {% if search_query %}
                        No se encontraron alimentos que coincidan con "<strong>{{ search_query }}</strong>".
                    {% else %}
                        No hay alimentos para mostrar.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Paginación -->
{% if alimentos_page.has_other_pages %}
<div class="pagination-container">
    <nav aria-label="Paginación de alimentos">
        <ul class="pagination">
            {% if alimentos_page.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1">Primera</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ alimentos_page.previous_page_number }}">Anterior</a>
                </li>
            {% endif %}

            <li class="page-item active">
                <span class="page-link">
                    Página {{ alimentos_page.number }} de {{ alimentos_page.paginator.num_pages }}
                </span>
            </li>

            {% if alimentos_page.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ alimentos_page.next_page_number }}">Siguiente</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ alimentos_page.paginator.num_pages }}">Última</a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}

<!-- MODAL para Añadir/Editar Alimento -->
<div id="alimento-modal" class="modal-overlay hidden-initially">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="modal-title">Añadir Alimento</h2>
            <span class="modal-close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <form id="alimento-form" method="POST" action="">
                {% csrf_token %}
                <div class="form-scroll-container modal-alimentos-scroll">
                    <div class="form-grid">
                        <!-- Campos básicos -->
                        <div class="form-section">
                            <h3>Información Básica</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_codigo">Código *</label>
                                    <input type="text" name="codigo" id="id_codigo" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="id_nombre_del_alimento">Nombre del Alimento *</label>
                                    <input type="text" name="nombre_del_alimento" id="id_nombre_del_alimento" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_parte_analizada">Parte Analizada</label>
                                    <input type="text" name="parte_analizada" id="id_parte_analizada" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_id_componente">Componente de Alimento</label>
                                    {{ form.id_componente }}
                                </div>
                            </div>
                        </div>

                        <!-- Macronutrientes -->
                        <div class="form-section">
                            <h3>Macronutrientes</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_humedad_g">Humedad (g) *</label>
                                    <input type="number" step="0.01" name="humedad_g" id="id_humedad_g" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="id_energia_kcal">Energía (kcal) *</label>
                                    <input type="number" step="0.01" name="energia_kcal" id="id_energia_kcal" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="id_energia_kj">Energía (kJ) *</label>
                                    <input type="number" step="0.01" name="energia_kj" id="id_energia_kj" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_proteina_g">Proteína (g) *</label>
                                    <input type="number" step="0.01" name="proteina_g" id="id_proteina_g" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="id_lipidos_g">Lípidos (g) *</label>
                                    <input type="number" step="0.01" name="lipidos_g" id="id_lipidos_g" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="id_carbohidratos_totales_g">Carbohidratos Totales (g) *</label>
                                    <input type="number" step="0.01" name="carbohidratos_totales_g" id="id_carbohidratos_totales_g" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_carbohidratos_disponibles_g">Carbohidratos Disponibles (g)</label>
                                    <input type="number" step="0.01" name="carbohidratos_disponibles_g" id="id_carbohidratos_disponibles_g" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_fibra_dietaria_g">Fibra Dietaria (g)</label>
                                    <input type="number" step="0.01" name="fibra_dietaria_g" id="id_fibra_dietaria_g" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_cenizas_g">Cenizas (g)</label>
                                    <input type="number" step="0.01" name="cenizas_g" id="id_cenizas_g" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- Minerales -->
                        <div class="form-section">
                            <h3>Minerales</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_calcio_mg">Calcio (mg)</label>
                                    <input type="number" step="0.01" name="calcio_mg" id="id_calcio_mg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_hierro_mg">Hierro (mg)</label>
                                    <input type="number" step="0.01" name="hierro_mg" id="id_hierro_mg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_sodio_mg">Sodio (mg)</label>
                                    <input type="number" step="0.01" name="sodio_mg" id="id_sodio_mg" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_fosforo_mg">Fósforo (mg)</label>
                                    <input type="number" step="0.01" name="fosforo_mg" id="id_fosforo_mg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_yodo_mg">Yodo (mg)</label>
                                    <input type="number" step="0.01" name="yodo_mg" id="id_yodo_mg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_zinc_mg">Zinc (mg)</label>
                                    <input type="number" step="0.01" name="zinc_mg" id="id_zinc_mg" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_magnesio_mg">Magnesio (mg)</label>
                                    <input type="number" step="0.01" name="magnesio_mg" id="id_magnesio_mg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_potasio_mg">Potasio (mg)</label>
                                    <input type="number" step="0.01" name="potasio_mg" id="id_potasio_mg" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- Vitaminas -->
                        <div class="form-section">
                            <h3>Vitaminas</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_tiamina_mg">Tiamina (mg)</label>
                                    <input type="number" step="0.01" name="tiamina_mg" id="id_tiamina_mg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_riboflavina_mg">Riboflavina (mg)</label>
                                    <input type="number" step="0.01" name="riboflavina_mg" id="id_riboflavina_mg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_niacina_mg">Niacina (mg)</label>
                                    <input type="number" step="0.01" name="niacina_mg" id="id_niacina_mg" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_folatos_mcg">Folatos (mcg)</label>
                                    <input type="number" step="0.01" name="folatos_mcg" id="id_folatos_mcg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_vitamina_b12_mcg">Vitamina B12 (mcg)</label>
                                    <input type="number" step="0.01" name="vitamina_b12_mcg" id="id_vitamina_b12_mcg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_vitamina_c_mg">Vitamina C (mg)</label>
                                    <input type="number" step="0.01" name="vitamina_c_mg" id="id_vitamina_c_mg" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_vitamina_a_er">Vitamina A (ER)</label>
                                    <input type="number" step="0.01" name="vitamina_a_er" id="id_vitamina_a_er" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- Grasas -->
                        <div class="form-section">
                            <h3>Tipos de Grasas</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_grasa_saturada_g">Grasa Saturada (g)</label>
                                    <input type="number" step="0.01" name="grasa_saturada_g" id="id_grasa_saturada_g" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_grasa_monoinsaturada_g">Grasa Monoinsaturada (g)</label>
                                    <input type="number" step="0.01" name="grasa_monoinsaturada_g" id="id_grasa_monoinsaturada_g" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_grasa_poliinsaturada_g">Grasa Poliinsaturada (g)</label>
                                    <input type="number" step="0.01" name="grasa_poliinsaturada_g" id="id_grasa_poliinsaturada_g" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="id_colesterol_mg">Colesterol (mg)</label>
                                    <input type="number" step="0.01" name="colesterol_mg" id="id_colesterol_mg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="id_parte_comestible_field">Parte Comestible (%)</label>
                                    <input type="number" step="0.01" name="parte_comestible_field" id="id_parte_comestible_field" class="form-control" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-cancel-btn">Cancelar</button>
                    <button type="submit" id="modal-submit-btn" class="btn btn-success">Guardar Alimento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para ver detalles -->
<div class="modal-overlay" id="detailModal" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalles del Alimento</h3>
                <span class="modal-close" onclick="closeDetailModal()">&times;</span>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}